<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Math Quiz Â· Reward</title>
  
  <!-- Tailwind CSS & Fonts -->
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <!-- Monetag SDK -->
  <script src='//libtl.com/sdk.js' data-zone='9865183' data-sdk='show_9865183'></script>
  
  <style>
    /* Global Styles */
    * { font-family: 'Poppins', sans-serif; }
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
    
    /* Custom Styles */
    .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
    .card-shadow { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    
    /* Animations */
    .toast { animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s; }
    @keyframes slideIn { 
      from { transform: translateY(-100px); opacity: 0; } 
      to { transform: translateY(0); opacity: 1; } 
    }
    @keyframes fadeOut { 
      from { opacity: 1; } 
      to { opacity: 0; } 
    }
    
    /* Button Styles */
    .btn-primary { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      transition: all 0.3s; 
    }
    .btn-primary:hover { 
      transform: translateY(-1px); 
      box-shadow: 0 4px 12px rgba(102,126,234,0.3); 
    }
    .btn-success { 
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); 
    }
    .btn-danger {
      background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
      transition: all 0.3s;
    }
    .btn-danger:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(245,101,101,0.3);
    }
    
    /* Input Field */
    .input-field { 
      transition: all 0.3s; 
      border: 1.5px solid #e2e8f0; 
    }
    .input-field:focus { 
      border-color: #667eea; 
      box-shadow: 0 0 0 3px rgba(102,126,234,0.1); 
      outline: none;
    }
    
    /* Page Navigation */
    .page { display: none !important; }
    .page.active { display: block !important; }
    
    /* Loading Spinner */
    .loading-spinner { 
      border: 2px solid #f3f3f3; 
      border-top: 2px solid #667eea; 
      border-radius: 50%; 
      width: 20px; 
      height: 20px; 
      animation: spin 1s linear infinite; 
    }
    @keyframes spin { 
      0% { transform: rotate(0deg); } 
      100% { transform: rotate(360deg); } 
    }
    
    /* Point Animation */
    .point-change { animation: pointPulse 0.5s ease; }
    @keyframes pointPulse { 
      0% { transform: scale(1); } 
      50% { transform: scale(1.15); } 
      100% { transform: scale(1); } 
    }
    
    /* Broadcast Banner */
    .broadcast-banner { 
      background: linear-gradient(90deg, #ff6b6b 0%, #ff8e72 100%); 
      color: white; 
      padding: 12px; 
      border-radius: 12px; 
      overflow: hidden; 
      margin-bottom: 16px; 
      position: relative; 
    }
    .broadcast-text { 
      animation: scrollText 15s linear infinite; 
      white-space: nowrap; 
      font-weight: 600; 
      font-size: 14px; 
      display: inline-block; 
    }
    @keyframes scrollText { 
      0% { transform: translateX(100%); } 
      100% { transform: translateX(-100%); } 
    }
    .broadcast-banner.paused .broadcast-text { animation-play-state: paused; }
    
    /* Layout */
    main { padding-bottom: 80px; }
    #main-app { display: flex; flex-direction: column; height: 100%; }
    
    /* Ad Loading Overlay */
    .ad-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }
    .ad-overlay.hidden {
      display: none;
    }
    .ad-spinner {
      border: 4px solid rgba(255,255,255,0.3);
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
    
    /* Quiz Refresh Button */
    .refresh-btn {
      transition: transform 0.3s;
    }
    .refresh-btn:hover {
      transform: rotate(180deg);
    }
    
    /* Device ID Badge */
    .device-badge {
      font-family: monospace;
      background: #f0f0f0;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
    }
    
    /* Admin Badge */
    .admin-badge {
      background: linear-gradient(135deg, #f6e05e 0%, #d69e2e 100%);
      color: #744210;
      font-size: 10px;
      font-weight: bold;
      padding: 2px 8px;
      border-radius: 12px;
      margin-left: 6px;
    }
    
    /* User Count Badge */
    .user-count-badge {
      background: #667eea;
      color: white;
      font-size: 12px;
      font-weight: bold;
      padding: 2px 10px;
      border-radius: 20px;
      margin-left: 8px;
    }
    
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.9);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }
    .loading-overlay.hidden {
      display: none;
    }
    .loading-spinner-large {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }
  </style>
</head>
<body class="bg-gray-50">
<div id="app" class="w-full h-full overflow-auto relative">
  
  <!-- Global Loading Overlay -->
  <div id="loading-overlay" class="loading-overlay">
    <div class="loading-spinner-large"></div>
    <p class="text-lg font-semibold text-gray-700">Memuat data dari server...</p>
    <p class="text-sm text-gray-500 mt-2">Mohon tunggu sebentar</p>
  </div>

  <!-- Ad Loading Overlay -->
  <div id="ad-overlay" class="ad-overlay hidden">
    <div class="ad-spinner"></div>
    <p class="text-lg font-semibold mb-2">Memuat Iklan...</p>
    <p class="text-sm opacity-75">Tonton iklan untuk mendapatkan reward</p>
  </div>

  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed top-4 left-1/2 -translate-x-1/2 z-50"></div>

  <!-- ========== LOGIN PAGE ========== -->
  <div id="login-page" class="page active w-full h-full">
    <div class="auth-container flex items-center justify-center min-h-full">
      <div class="w-full max-w-sm px-4">
        <div class="text-center mb-6">
          <h1 id="app-title" class="text-3xl font-bold text-gray-800">Math Quiz</h1>
          <p class="text-sm text-gray-500 mt-1">Jawab quiz & dapatkan reward!</p>
        </div>
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <form id="login-form" class="space-y-3">
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-2">Username</label>
              <input type="text" id="login-username" class="input-field w-full px-3 py-2.5 rounded-lg outline-none text-sm" placeholder="Masukkan username" required>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-2">Password</label>
              <input type="password" id="login-password" class="input-field w-full px-3 py-2.5 rounded-lg outline-none text-sm" placeholder="Masukkan password" required>
            </div>
            <button type="submit" id="login-btn" class="btn-primary w-full py-2.5 rounded-lg text-white font-semibold text-sm mt-4">
              <span id="login-btn-text">Masuk</span>
            </button>
          </form>
          <p class="text-center mt-4 text-gray-500 text-xs">
            Belum punya akun? 
            <button type="button" onclick="showPage('register-page')" class="text-purple-600 font-semibold hover:underline">Daftar</button>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== REGISTER PAGE ========== -->
  <div id="register-page" class="page w-full h-full">
    <div class="auth-container flex items-center justify-center min-h-full">
      <div class="w-full max-w-sm px-4">
        <div class="text-center mb-6">
          <h1 class="text-3xl font-bold text-gray-800">Daftar Akun</h1>
          <p class="text-sm text-gray-500 mt-1">Buat akun baru untuk mulai bermain</p>
        </div>
        <div class="bg-white rounded-2xl p-6 card-shadow">
          <form id="register-form" class="space-y-3">
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-2">Username</label>
              <input type="text" id="reg-username" class="input-field w-full px-3 py-2.5 rounded-lg outline-none text-sm" placeholder="Pilih username" required>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-2">Password</label>
              <input type="password" id="reg-password" class="input-field w-full px-3 py-2.5 rounded-lg outline-none text-sm" placeholder="Buat password" required>
            </div>
            <div>
              <label class="block text-xs font-semibold text-gray-700 mb-2">Negara</label>
              <select id="reg-country" class="input-field w-full px-3 py-2.5 rounded-lg outline-none bg-white text-sm" required>
                <option value="">Pilih negara...</option>
                <option value="Indonesia" selected>ğŸ‡®ğŸ‡© Indonesia</option>
                <option value="Malaysia">ğŸ‡²ğŸ‡¾ Malaysia</option>
                <option value="Singapore">ğŸ‡¸ğŸ‡¬ Singapore</option>
                <option value="Thailand">ğŸ‡¹ğŸ‡­ Thailand</option>
                <option value="Vietnam">ğŸ‡»ğŸ‡³ Vietnam</option>
                <option value="Philippines">ğŸ‡µğŸ‡­ Philippines</option>
              </select>
            </div>
            <button type="submit" id="register-btn" class="btn-primary w-full py-2.5 rounded-lg text-white font-semibold text-sm mt-4">
              <span id="register-btn-text">Daftar</span>
            </button>
          </form>
          <p class="text-center mt-4 text-gray-500 text-xs">
            Sudah punya akun? 
            <button type="button" onclick="showPage('login-page')" class="text-purple-600 font-semibold hover:underline">Masuk</button>
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- ========== MAINTENANCE PAGE ========== -->
  <div id="maintenance-page" class="page w-full h-full">
    <div class="auth-container flex items-center justify-center min-h-full">
      <div class="text-center px-4">
        <div class="w-20 h-20 bg-yellow-100 rounded-full mx-auto mb-4 flex items-center justify-center">
          <span class="text-3xl">ğŸ”§</span>
        </div>
        <h1 class="text-2xl font-bold text-gray-800 mb-2">Maintenance</h1>
        <p class="text-gray-500 max-w-xs text-sm">Aplikasi sedang dalam perbaikan. Silakan kembali beberapa saat lagi.</p>
        <button type="button" onclick="handleLogout()" class="mt-6 px-4 py-2 bg-gray-200 rounded-lg text-gray-700 font-semibold hover:bg-gray-300 transition text-sm">Logout</button>
      </div>
    </div>
  </div>

  <!-- ========== MAIN APPLICATION ========== -->
  <div id="main-app" class="page w-full h-full">
    
    <!-- Header -->
    <header class="gradient-bg text-white p-3 sticky top-0 z-40">
      <div class="max-w-2xl mx-auto flex items-center justify-between">
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
            <span class="text-sm">ğŸ‘¤</span>
          </div>
          <div>
            <p id="header-username" class="font-semibold text-sm">Username</p>
            <p id="header-points" class="text-xs opacity-80">0 Poin</p>
          </div>
        </div>
        <button type="button" onclick="handleLogout()" class="px-3 py-1.5 bg-white/20 rounded-lg hover:bg-white/30 transition text-xs font-medium">Logout</button>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 p-3 overflow-auto">
      <div class="max-w-2xl mx-auto">
        
        <!-- Broadcast Banner (hidden by default) -->
        <div id="broadcast-container" class="hidden">
          <div class="broadcast-banner" onmouseenter="this.classList.add('paused')" onmouseleave="this.classList.remove('paused')">
            <span class="broadcast-text" id="broadcast-text-display">ğŸ“¢ </span>
          </div>
        </div>

        <!-- ===== QUIZ SECTION ===== -->
        <div id="quiz-section" class="section">
          <div class="bg-white rounded-2xl p-4 card-shadow mb-3">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <h2 class="text-lg font-bold text-gray-800">ğŸ¯ Quiz Matematika</h2>
                <!-- Auto-refresh Indicator -->
                <span id="quiz-refresh-indicator" class="text-xs text-purple-600 opacity-0">ğŸ”„ Auto-refresh</span>
              </div>
              <div class="flex items-center gap-2">
                <div class="px-3 py-1.5 bg-purple-100 rounded-lg">
                  <span id="quiz-points" class="font-bold text-purple-600 text-sm">0 Poin</span>
                </div>
                <!-- Manual Refresh Button -->
                <button type="button" onclick="manualRefreshQuiz()" class="refresh-btn w-8 h-8 bg-gray-100 hover:bg-purple-100 rounded-lg flex items-center justify-center transition" title="Refresh Quiz">
                  <span class="text-lg">ğŸ”„</span>
                </button>
              </div>
            </div>
            <div id="quiz-container">
              <div class="text-center py-6 bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl mb-4">
                <p class="text-gray-500 mb-1 text-xs">Berapa hasil dari:</p>
                <p id="quiz-question" class="text-3xl font-bold text-gray-800">0 + 0 = ?</p>
              </div>
              <div id="quiz-options" class="grid grid-cols-2 gap-2 mb-4"></div>
              <div id="claim-reward-container" class="hidden">
                <button type="button" id="claim-reward-btn" onclick="claimReward()" class="btn-success w-full py-3 rounded-lg text-white font-bold text-sm flex items-center justify-center gap-2">
                  <span>ğŸ</span>
                  <span>Klaim Reward (Tonton Iklan)</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== HISTORY SECTION ===== -->
        <div id="history-section" class="section hidden">
          <div class="bg-white rounded-2xl p-4 card-shadow mb-3">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <h2 class="text-lg font-bold text-gray-800">ğŸ’° Poin Saya</h2>
                <span id="refresh-indicator" class="text-xs text-green-600 opacity-0">ğŸ”„ Auto-refresh</span>
              </div>
              <div class="px-3 py-1.5 bg-green-100 rounded-lg">
                <span id="history-points" class="font-bold text-green-600 text-sm">0 Poin</span>
              </div>
            </div>
            <button type="button" onclick="showExchangeForm()" class="btn-primary w-full py-2.5 rounded-lg text-white font-semibold text-sm mb-3">Tukar Poin</button>
            <p class="text-xs text-gray-500 text-center">Minimal: 50 Poin = Rp 50</p>
          </div>
          
          <!-- Exchange Form (hidden by default) -->
          <div id="exchange-form-container" class="bg-white rounded-2xl p-4 card-shadow mb-3 hidden">
            <h3 class="text-base font-bold text-gray-800 mb-3">ğŸ“ Form Penukaran</h3>
            <form id="exchange-form" class="space-y-2.5">
              <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1.5">Jumlah Poin</label>
                <input type="number" id="exchange-amount" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="Min. 50 poin" min="50" required>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1.5">Nama Akun DANA</label>
                <input type="text" id="dana-account" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="Nama lengkap" required>
              </div>
              <div>
                <label class="block text-xs font-semibold text-gray-700 mb-1.5">Nomor HP DANA</label>
                <input type="tel" id="dana-phone" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="08xxxxxxxxxx" required>
              </div>
              <div class="flex gap-2 pt-2">
                <button type="button" onclick="hideExchangeForm()" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-700 font-semibold text-xs">Batal</button>
                <button type="submit" id="exchange-submit-btn" class="flex-1 btn-primary py-2 rounded-lg text-white font-semibold text-xs">Kirim Permintaan</button>
              </div>
            </form>
          </div>
          
          <!-- Exchange History -->
          <div class="bg-white rounded-2xl p-4 card-shadow">
            <h3 class="text-base font-bold text-gray-800 mb-3">ğŸ“‹ Riwayat Penukaran</h3>
            <div id="exchange-history" class="space-y-2">
              <p class="text-gray-500 text-center py-3 text-xs">Belum ada riwayat</p>
            </div>
          </div>
        </div>

        <!-- ===== PROFILE SECTION ===== -->
        <div id="profile-section" class="section hidden">
          <div class="bg-white rounded-2xl p-4 card-shadow">
            <div class="text-center mb-4">
              <div class="w-16 h-16 gradient-bg rounded-full mx-auto mb-3 flex items-center justify-center">
                <span class="text-2xl">ğŸ‘¤</span>
              </div>
              <h2 id="profile-username" class="text-xl font-bold text-gray-800">Username</h2>
              <span id="profile-role" class="inline-block mt-1.5 px-2.5 py-1 bg-purple-100 text-purple-600 rounded-full text-xs font-medium">User</span>
            </div>
            <div class="space-y-2">
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="text-gray-600 text-sm">ğŸŒ Negara</span>
                <span id="profile-country" class="font-semibold text-gray-800 text-sm">-</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="text-gray-600 text-sm">ğŸ“± Device ID</span>
                <span id="profile-device" class="font-semibold text-gray-800 text-xs device-badge">-</span>
              </div>
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <span class="text-gray-600 text-sm">ğŸ’° Total Poin</span>
                <span id="profile-points" class="font-semibold text-green-600">0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- ===== SETTINGS SECTION (ADMIN ONLY) ===== -->
        <div id="settings-section" class="section hidden">
          <div class="space-y-3">
            
            <!-- Database Status -->
            <div class="bg-white rounded-2xl p-4 card-shadow">
              <h2 class="text-lg font-bold text-gray-800 mb-3">â˜ï¸ Database Status</h2>
              <div class="space-y-2">
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <span class="text-gray-600 text-sm">ğŸ”— Koneksi</span>
                  <span id="connection-status" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">âœ“ Connected</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <span class="text-gray-600 text-sm">ğŸ“Š Total Users</span>
                  <span class="font-semibold text-gray-800 text-sm" id="total-users">0</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <span class="text-gray-600 text-sm">ğŸ‘‘ Admin</span>
                  <span class="font-semibold text-gray-800 text-sm" id="total-admins">0</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <span class="text-gray-600 text-sm">â±ï¸ Status</span>
                  <span class="font-semibold text-gray-800 text-sm" id="db-status">Aktif</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                  <span class="text-gray-600 text-sm">ğŸ”„ Last Sync</span>
                  <span id="last-sync-time" class="font-semibold text-gray-800 text-sm">-</span>
                </div>
              </div>
              <button type="button" onclick="refreshAllData()" class="mt-3 w-full py-2 bg-blue-100 text-blue-700 rounded-lg text-sm font-medium hover:bg-blue-200 flex items-center justify-center gap-2">
                <span>ğŸ”„</span>
                <span>Refresh Data dari Server</span>
              </button>
            </div>
            
            <!-- Broadcast Message Form -->
            <div class="bg-white rounded-2xl p-4 card-shadow">
              <h2 class="text-lg font-bold text-gray-800 mb-3">ğŸ“¢ Pesan Broadcast</h2>
              <form id="broadcast-form" class="space-y-2.5">
                <div>
                  <textarea id="broadcast-message" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" rows="3" placeholder="Ketik pesan untuk semua user..." required maxlength="100"></textarea>
                  <p id="char-count" class="text-xs text-gray-500 mt-1">0/100</p>
                </div>
                <button type="submit" class="btn-primary w-full py-2.5 rounded-lg text-white font-semibold text-sm flex items-center justify-center gap-2">
                  <span>ğŸ“¤</span>
                  <span>Kirim Broadcast</span>
                </button>
              </form>
            </div>
            
            <!-- Admin Settings -->
            <div class="bg-white rounded-2xl p-4 card-shadow">
              <h2 class="text-lg font-bold text-gray-800 mb-3">âš™ï¸ Pengaturan Admin</h2>
              
              <!-- Maintenance Toggle -->
              <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-3">
                <div>
                  <p class="font-semibold text-gray-800 text-sm">Mode Maintenance</p>
                  <p class="text-xs text-gray-500">Nonaktifkan akses user</p>
                </div>
                <label class="relative inline-flex items-center cursor-pointer">
                  <input type="checkbox" id="maintenance-toggle" class="sr-only peer" onchange="toggleMaintenance()">
                  <div class="w-12 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                </label>
              </div>
              
              <!-- Reward Points Setting -->
              <div class="p-3 bg-gray-50 rounded-lg">
                <p class="font-semibold text-gray-800 text-sm mb-2">Poin Reward per Klaim</p>
                <div class="flex gap-2">
                  <input type="number" id="reward-points-input" class="input-field flex-1 px-3 py-2 rounded-lg outline-none text-sm" value="50" min="1">
                  <button type="button" onclick="updateRewardPoints()" class="px-3 py-2 btn-primary rounded-lg text-white font-semibold text-xs">Simpan</button>
                </div>
              </div>
            </div>
            
            <!-- User Management (SEMUA AKUN TERDAFTAR) -->
            <div class="bg-white rounded-2xl p-4 card-shadow">
              <div class="flex items-center justify-between mb-3">
                <h3 class="text-base font-bold text-gray-800">ğŸ‘¥ Semua Akun Terdaftar</h3>
                <span id="user-count-badge" class="user-count-badge">0 Users</span>
              </div>
              <div id="user-list" class="space-y-2">
                <p class="text-gray-500 text-center py-3 text-xs">Memuat data...</p>
              </div>
            </div>
            
            <!-- Exchange Requests (Admin View) DENGAN TOMBOL HAPUS -->
            <div class="bg-white rounded-2xl p-4 card-shadow">
              <h3 class="text-base font-bold text-gray-800 mb-3 flex items-center justify-between">
                <span>ğŸ’³ Riwayat Penukaran</span>
                <button type="button" onclick="clearAllExchanges()" class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200">Hapus Semua</button>
              </h3>
              <div id="admin-exchange-list" class="space-y-2">
                <p class="text-gray-500 text-center py-3 text-xs">Belum ada permintaan</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bg-white border-t border-gray-200 px-4 py-2 mt-auto">
      <div class="flex justify-around max-w-2xl mx-auto">
        <button type="button" onclick="showSection('quiz')" class="nav-btn flex flex-col items-center p-1.5 rounded-lg transition" data-section="quiz">
          <span class="text-xl">ğŸ¯</span>
          <span class="text-xs font-medium text-gray-600">Quiz</span>
        </button>
        <button type="button" onclick="showSection('history')" class="nav-btn flex flex-col items-center p-1.5 rounded-lg transition" data-section="history">
          <span class="text-xl">ğŸ“‹</span>
          <span class="text-xs font-medium text-gray-600">Riwayat</span>
        </button>
        <button type="button" onclick="showSection('profile')" class="nav-btn flex flex-col items-center p-1.5 rounded-lg transition" data-section="profile">
          <span class="text-xl">ğŸ‘¤</span>
          <span class="text-xs font-medium text-gray-600">Profil</span>
        </button>
        <button id="settings-nav-btn" type="button" onclick="showSection('settings')" class="nav-btn flex flex-col items-center p-1.5 rounded-lg hidden transition" data-section="settings">
          <span class="text-xl">âš™ï¸</span>
          <span class="text-xs font-medium text-gray-600">Setting</span>
        </button>
      </div>
    </nav>
  </div>

  <!-- ========== MODALS ========== -->
  
  <!-- Edit User Modal -->
  <div id="edit-user-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-4 w-full max-w-sm">
      <h3 class="text-lg font-bold text-gray-800 mb-3">Edit User</h3>
      <form id="edit-user-form" class="space-y-2.5">
        <input type="hidden" id="edit-user-id">
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1.5">Username</label>
          <input type="text" id="edit-user-username" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" readonly>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1.5">Role</label>
          <input type="text" id="edit-user-role" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" readonly>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1.5">Device ID</label>
          <input type="text" id="edit-user-device" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" readonly>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1.5">Password Baru</label>
          <input type="password" id="edit-user-password" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="Kosongkan jika tidak diubah">
        </div>
        <div class="p-3 bg-blue-50 rounded-lg">
          <p class="text-xs font-semibold text-gray-700 mb-1.5">Poin Saat Ini</p>
          <p id="edit-user-current-points" class="text-xl font-bold text-blue-600">0</p>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1.5">Total Poin Baru</label>
          <input type="number" id="edit-user-new-points" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="0" min="0">
        </div>
        <div class="flex gap-2 pt-2">
          <button type="button" onclick="closeEditUserModal()" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-700 font-semibold text-xs">Batal</button>
          <button type="submit" class="flex-1 btn-primary py-2 rounded-lg text-white font-semibold text-xs">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Exchange Status Modal (Admin) -->
  <div id="exchange-status-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-4 w-full max-w-sm">
      <h3 class="text-lg font-bold text-gray-800 mb-3">Ubah Status Penukaran</h3>
      <form id="exchange-status-form" class="space-y-2.5">
        <input type="hidden" id="exchange-status-id">
        <input type="hidden" id="exchange-status-user-id">
        <input type="hidden" id="exchange-status-amount">
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1.5">Status</label>
          <select id="exchange-status-select" class="input-field w-full px-3 py-2 rounded-lg outline-none bg-white text-sm" required>
            <option value="success">Berhasil</option>
            <option value="rejected">Tolak</option>
          </select>
        </div>
        <div>
          <label class="block text-xs font-semibold text-gray-700 mb-1.5">Catatan Admin</label>
          <textarea id="exchange-status-note" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" rows="2" placeholder="Tambahkan catatan..."></textarea>
        </div>
        <div class="flex gap-2 pt-2">
          <button type="button" onclick="closeExchangeStatusModal()" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-700 font-semibold text-xs">Batal</button>
          <button type="submit" class="flex-1 btn-primary py-2 rounded-lg text-white font-semibold text-xs">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confirm Delete Modal -->
  <div id="confirm-delete-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-4 w-full max-w-sm">
      <h3 class="text-lg font-bold text-gray-800 mb-3">Konfirmasi Hapus</h3>
      <p id="delete-confirm-message" class="text-sm text-gray-600 mb-4">Apakah Anda yakin ingin menghapus data ini?</p>
      <div class="flex gap-2">
        <button type="button" onclick="closeDeleteModal()" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-700 font-semibold text-xs">Batal</button>
        <button type="button" id="confirm-delete-btn" class="flex-1 btn-danger py-2 rounded-lg text-white font-semibold text-xs">Hapus</button>
      </div>
    </div>
  </div>
</div>

<script>
// ==================== GOOGLE APPS SCRIPT CONFIGURATION ====================
// URL Google Apps Script yang sudah di-deploy
const GAS_URL = 'https://script.google.com/macros/s/AKfycbzqdAFW6jru6IUGvcuWZb5Lk9eebAhfg8FoPo60d4H0kkPww3VZEIJ-J2JeLS5Npc_Iww/exec';

// ==================== MONETAG AD CONFIGURATION ====================
const monetagReady = typeof show_9865183 === 'function';

// ==================== STATE VARIABLES ====================
let currentUser = null;
let allUsers = [];
let allExchanges = [];
let allBroadcasts = [];
let appSettings = {
  maintenanceMode: false,
  rewardPoints: 50
};

let currentQuiz = null;
let isAnswerCorrect = false;
let historyRefreshInterval = null;
let quizRefreshInterval = null;
let isClaimingReward = false;
let isLoading = false;

// Untuk delete confirmation
let pendingDeleteAction = null;

// Generate or retrieve Device ID
function generateDeviceId() {
  const stored = sessionStorage.getItem('deviceId');
  if (stored) return stored;
  const id = 'DEV-' + Math.random().toString(36).substring(2, 10).toUpperCase();
  sessionStorage.setItem('deviceId', id);
  return id;
}

const deviceId = generateDeviceId();

// ==================== LOADING FUNCTIONS ====================
function showLoading(message = 'Memuat data dari server...') {
  isLoading = true;
  const overlay = document.getElementById('loading-overlay');
  overlay.querySelector('p.text-lg').textContent = message;
  overlay.classList.remove('hidden');
}

function hideLoading() {
  isLoading = false;
  document.getElementById('loading-overlay').classList.add('hidden');
}

// ==================== GOOGLE APPS SCRIPT SYNC FUNCTIONS ====================

// Fungsi untuk mengambil semua data dari server
async function fetchAllData() {
  showLoading('Mengambil data dari server...');
  
  try {
    // Karena Google Apps Script hanya mendukung POST, kita akan menggunakan pendekatan berbeda
    // Kita perlu membuat endpoint GET atau menggunakan teknik lain
    // Untuk sementara, kita akan menggunakan data dari cache
    
    // Dalam implementasi nyata, Anda perlu menambahkan fungsi doGet di Apps Script
    // yang mengembalikan semua data
    
    console.log('Mencoba mengambil data dari server...');
    
    // Simulasi - dalam praktiknya, Anda perlu implementasi doGet
    await new Promise(resolve => setTimeout(resolve, 1000));
    
    // Gunakan cache sebagai fallback
    const cached = localStorage.getItem('math_quiz_cache');
    if (cached) {
      const data = JSON.parse(cached);
      allUsers = data.users || [];
      allExchanges = data.exchanges || [];
      allBroadcasts = data.broadcasts || [];
      appSettings = data.settings || { maintenanceMode: false, rewardPoints: 50 };
      console.log('Data loaded from cache:', allUsers.length, 'users');
    }
    
    hideLoading();
    return true;
  } catch (error) {
    console.error('Error fetching data:', error);
    hideLoading();
    showToast('Gagal mengambil data dari server', 'error');
    return false;
  }
}

// Fungsi untuk mengirim data ke Google Sheets
async function syncToGoogle(action, data) {
  if (!GAS_URL) {
    showToast('Konfigurasi server tidak valid!', 'error');
    return false;
  }

  try {
    // Untuk operasi yang memerlukan loading
    const showLoad = !['syncUsers', 'syncExchanges', 'syncBroadcasts', 'syncSettings'].includes(action);
    
    if (showLoad) {
      showLoading(`Menyimpan data ke server...`);
    }

    // Siapkan payload sesuai format Apps Script
    const payload = {
      action: action,
      data: data,
      timestamp: new Date().toISOString()
    };

    // Kirim ke server dengan mode no-cors
    const response = await fetch(GAS_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(payload)
    });

    console.log(`Sync ${action} completed`);
    
    // Update cache lokal
    updateLocalCache();
    
    if (showLoad) {
      hideLoading();
    }
    
    return true;
  } catch (error) {
    console.error('Sync error:', error);
    if (showLoad) {
      hideLoading();
    }
    showToast('Gagal sync ke server', 'error');
    return false;
  }
}

// Update cache lokal
function updateLocalCache() {
  const cache = {
    users: allUsers,
    exchanges: allExchanges,
    broadcasts: allBroadcasts,
    settings: appSettings,
    lastUpdated: new Date().toISOString()
  };
  localStorage.setItem('math_quiz_cache', JSON.stringify(cache));
}

// Refresh semua data dari server
async function refreshAllData() {
  await fetchAllData();
  showToast('Data berhasil di-refresh dari server', 'success');
  
  // Update UI
  if (currentUser) {
    // Cek apakah user masih ada di database
    const userExists = allUsers.some(u => u.id === currentUser.id);
    if (!userExists) {
      showToast('Sesi Anda telah berakhir, silakan login ulang', 'error');
      handleLogout();
      return;
    }
    
    // Update data user
    const updatedUser = allUsers.find(u => u.id === currentUser.id);
    if (updatedUser) {
      currentUser = updatedUser;
      updatePointsDisplay();
    }
  }
  
  updateUI();
}

// Update UI setelah data berubah
function updateUI() {
  if (currentUser) {
    updatePointsDisplay();
    displayBroadcast();
  }
  
  if (document.getElementById('settings-section').classList.contains('hidden') === false) {
    renderUserList();
    renderAdminExchangeList();
    updateDatabaseStatus();
  }
  
  if (document.getElementById('history-section').classList.contains('hidden') === false) {
    renderExchangeHistory();
  }
}

// ==================== MONETAG AD FUNCTIONS ====================
async function showMonetagAd(type = 'reward') {
  return new Promise((resolve, reject) => {
    if (typeof show_9865183 !== 'function') {
      console.error('Monetag SDK tidak tersedia');
      setTimeout(resolve, 1000);
      return;
    }

    const overlay = document.getElementById('ad-overlay');
    overlay.classList.remove('hidden');
    
    const adText = overlay.querySelector('p.text-sm');
    if (adText) {
      if (type === 'exchange') {
        adText.textContent = 'Tonton iklan untuk mengirim permintaan penukaran';
      } else {
        adText.textContent = 'Tonton iklan untuk mendapatkan reward';
      }
    }

    const timeout = setTimeout(() => {
      overlay.classList.add('hidden');
      resolve();
    }, 5000);

    try {
      show_9865183().then(() => {
        clearTimeout(timeout);
        overlay.classList.add('hidden');
        console.log('Iklan Monetag selesai');
        resolve();
      }).catch((error) => {
        clearTimeout(timeout);
        overlay.classList.add('hidden');
        console.error('Error Monetag:', error);
        resolve();
      });
    } catch (error) {
      clearTimeout(timeout);
      overlay.classList.add('hidden');
      console.error('Error menjalankan Monetag:', error);
      resolve();
    }
  });
}

// ==================== HELPER FUNCTIONS ====================
function showToast(message, type = 'info') {
  const container = document.getElementById('toast-container');
  const toast = document.createElement('div');
  const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
  toast.className = `toast ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg font-medium text-sm`;
  toast.textContent = message;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

function showPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
}

function showSection(section) {
  document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
  document.getElementById(`${section}-section`).classList.remove('hidden');
  
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.classList.remove('menu-active');
    if (btn.dataset.section === section) {
      btn.classList.add('menu-active');
    }
  });

  stopHistoryRefresh();
  stopQuizRefresh();
  
  if (section === 'history') {
    renderExchangeHistory();
    startHistoryRefresh();
  } else if (section === 'quiz') {
    resetQuizState();
    generateQuiz();
    startQuizRefresh();
  } else if (section === 'settings') {
    renderUserList();
    renderAdminExchangeList();
    updateDatabaseStatus();
  }
}

// ==================== QUIZ REFRESH FUNCTIONS ====================
function stopQuizRefresh() {
  if (quizRefreshInterval) {
    clearInterval(quizRefreshInterval);
    quizRefreshInterval = null;
  }
  const indicator = document.getElementById('quiz-refresh-indicator');
  if (indicator) indicator.classList.add('opacity-0');
}

function startQuizRefresh() {
  const indicator = document.getElementById('quiz-refresh-indicator');
  if (indicator) indicator.classList.remove('opacity-0');
  
  if (quizRefreshInterval) clearInterval(quizRefreshInterval);
  
  quizRefreshInterval = setInterval(() => {
    if (document.getElementById('quiz-section').classList.contains('hidden') === false) {
      console.log('Auto-refresh quiz');
      generateQuiz();
    }
  }, 30000);
}

function manualRefreshQuiz() {
  showToast('Mereset quiz...', 'info');
  generateQuiz();
}

// ==================== HISTORY REFRESH FUNCTIONS ====================
function stopHistoryRefresh() {
  if (historyRefreshInterval) {
    clearInterval(historyRefreshInterval);
    historyRefreshInterval = null;
  }
  const indicator = document.getElementById('refresh-indicator');
  if (indicator) indicator.classList.add('opacity-0');
}

function startHistoryRefresh() {
  const indicator = document.getElementById('refresh-indicator');
  if (indicator) indicator.classList.remove('opacity-0');
  
  if (historyRefreshInterval) clearInterval(historyRefreshInterval);
  historyRefreshInterval = setInterval(() => {
    renderExchangeHistory();
  }, 5000);
}

function updateDatabaseStatus() {
  const totalUsers = allUsers.length;
  const totalAdmins = allUsers.filter(u => u.role === 'admin').length;
  
  document.getElementById('total-users').textContent = totalUsers;
  document.getElementById('total-admins').textContent = totalAdmins;
  document.getElementById('db-status').textContent = 'Aktif';
  document.getElementById('last-sync-time').textContent = new Date().toLocaleTimeString();
}

// ==================== SESSION MANAGEMENT ====================
function saveSession(user) {
  const session = {
    userId: user.id,
    username: user.username,
    role: user.role,
    loginTime: new Date().toISOString()
  };
  sessionStorage.setItem('userSession', JSON.stringify(session));
}

function getSession() {
  const session = sessionStorage.getItem('userSession');
  if (!session) return null;
  
  try {
    const parsed = JSON.parse(session);
    const loginTime = new Date(parsed.loginTime);
    const now = new Date();
    const diffHours = (now - loginTime) / (1000 * 60 * 60);
    
    if (diffHours >= 24) {
      sessionStorage.removeItem('userSession');
      return null;
    }
    return parsed;
  } catch (e) {
    return null;
  }
}

function clearSession() {
  sessionStorage.removeItem('userSession');
}

// ==================== BROADCAST FUNCTIONS ====================
function displayBroadcast() {
  const latestBroadcast = allBroadcasts
    .sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt))[0];
  
  if (latestBroadcast) {
    const container = document.getElementById('broadcast-container');
    const textDisplay = document.getElementById('broadcast-text-display');
    if (container && textDisplay) {
      textDisplay.textContent = 'ğŸ“¢ ' + latestBroadcast.message;
      container.classList.remove('hidden');
    }
  }
}

async function submitBroadcast(e) {
  e.preventDefault();
  
  if (!currentUser || currentUser.role !== 'admin') {
    showToast('Hanya admin yang bisa broadcast', 'error');
    return;
  }
  
  const message = document.getElementById('broadcast-message').value.trim();
  
  if (!message) {
    showToast('Pesan tidak boleh kosong!', 'error');
    return;
  }
  
  const broadcast = {
    __backendId: 'BC-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
    message: message,
    sentAt: new Date().toISOString(),
    sentBy: currentUser.username
  };
  
  allBroadcasts.push(broadcast);
  
  await syncToGoogle('createBroadcast', broadcast);
  
  document.getElementById('broadcast-form').reset();
  document.getElementById('char-count').textContent = '0/100';
  showToast('Pesan broadcast berhasil dikirim!', 'success');
  
  displayBroadcast();
}

// ==================== QUIZ FUNCTIONS ====================
function resetQuizState() {
  isAnswerCorrect = false;
  isClaimingReward = false;
  document.getElementById('claim-reward-container').classList.add('hidden');
  
  const claimBtn = document.getElementById('claim-reward-btn');
  claimBtn.disabled = false;
  claimBtn.innerHTML = '<span>ğŸ</span><span>Klaim Reward (Tonton Iklan)</span>';
}

function generateQuiz() {
  resetQuizState();
  
  const a = Math.floor(Math.random() * 50) + 1;
  const b = Math.floor(Math.random() * 50) + 1;
  const correct = a + b;
  
  const options = [correct];
  while (options.length < 4) {
    const wrong = correct + Math.floor(Math.random() * 21) - 10;
    if (wrong !== correct && wrong > 0 && !options.includes(wrong)) {
      options.push(wrong);
    }
  }
  
  for (let i = options.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [options[i], options[j]] = [options[j], options[i]];
  }
  
  currentQuiz = { a, b, correct, options };
  renderQuiz();
}

function renderQuiz() {
  if (!currentQuiz) return;
  
  document.getElementById('quiz-question').textContent = `${currentQuiz.a} + ${currentQuiz.b} = ?`;
  
  const optionsContainer = document.getElementById('quiz-options');
  optionsContainer.innerHTML = currentQuiz.options.map(opt => `
    <button type="button" onclick="checkAnswer(${opt})" class="p-3 bg-gray-100 hover:bg-purple-100 rounded-lg text-lg font-bold text-gray-800 transition">
      ${opt}
    </button>
  `).join('');
}

function checkAnswer(answer) {
  if (isAnswerCorrect || isClaimingReward) return;
  
  if (answer === currentQuiz.correct) {
    showToast('ğŸ‰ Jawaban Benar!', 'success');
    isAnswerCorrect = true;
    document.getElementById('claim-reward-container').classList.remove('hidden');
  } else {
    showToast('âŒ Jawaban Salah!', 'error');
    setTimeout(generateQuiz, 1000);
  }
}

async function claimReward() {
  if (!isAnswerCorrect || !currentUser || isClaimingReward) return;
  
  isClaimingReward = true;
  
  const btn = document.getElementById('claim-reward-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
  
  try {
    showToast('Menampilkan iklan...', 'info');
    await showMonetagAd('reward');
    
    const rewardAmount = appSettings?.rewardPoints || 50;
    currentUser.points = (currentUser.points || 0) + rewardAmount;
    
    const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
    if (userIndex >= 0) {
      allUsers[userIndex] = currentUser;
    }
    
    await syncToGoogle('updateUser', currentUser);
    
    showToast(`+${rewardAmount} Poin! Terima kasih telah menonton iklan`, 'success');
    updatePointsDisplay();
    
    resetQuizState();
    generateQuiz();
    
  } catch (error) {
    console.error('Error dalam proses iklan:', error);
    showToast('Iklan gagal, coba lagi nanti', 'error');
    
    isClaimingReward = false;
    isAnswerCorrect = true;
    
    btn.disabled = false;
    btn.innerHTML = '<span>ğŸ</span><span>Klaim Reward (Tonton Iklan)</span>';
  }
}

function updatePointsDisplay() {
  if (!currentUser) return;
  const points = currentUser.points || 0;
  
  document.getElementById('header-points').textContent = `${points} Poin`;
  document.getElementById('quiz-points').textContent = `${points} Poin`;
  document.getElementById('history-points').textContent = `${points} Poin`;
  document.getElementById('profile-points').textContent = points;
}

// ==================== EXCHANGE FUNCTIONS ====================
function showExchangeForm() {
  document.getElementById('exchange-form-container').classList.remove('hidden');
}

function hideExchangeForm() {
  document.getElementById('exchange-form-container').classList.add('hidden');
  document.getElementById('exchange-form').reset();
}

async function submitExchange(e) {
  e.preventDefault();
  
  if (!currentUser) {
    showToast('Silakan login terlebih dahulu', 'error');
    return;
  }
  
  const amount = parseInt(document.getElementById('exchange-amount').value);
  const danaAccount = document.getElementById('dana-account').value;
  const danaPhone = document.getElementById('dana-phone').value;
  
  if (amount < 50) {
    showToast('Minimal penukaran 50 poin!', 'error');
    return;
  }
  
  if ((currentUser.points || 0) < amount) {
    showToast('Poin tidak mencukupi!', 'error');
    return;
  }
  
  const submitBtn = document.getElementById('exchange-submit-btn');
  submitBtn.disabled = true;
  submitBtn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
  
  try {
    showToast('Menampilkan iklan...', 'info');
    await showMonetagAd('exchange');
    
    currentUser.points = (currentUser.points || 0) - amount;
    
    const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
    if (userIndex >= 0) {
      allUsers[userIndex] = currentUser;
    }
    
    const exchange = {
      __backendId: 'EX-' + Date.now() + '-' + Math.random().toString(36).substr(2, 5),
      username: currentUser.username,
      amount: amount,
      danaAccount: danaAccount,
      danaPhone: danaPhone,
      status: 'pending',
      adminNote: '',
      requestedAt: new Date().toISOString()
    };
    
    allExchanges.push(exchange);
    
    await syncToGoogle('createExchange', exchange);
    await syncToGoogle('updateUser', currentUser);
    
    hideExchangeForm();
    updatePointsDisplay();
    showToast('âœ… Permintaan penukaran berhasil dikirim!', 'success');
    renderExchangeHistory();
    
  } catch (error) {
    console.error('Error dalam proses penukaran:', error);
    showToast('Terjadi kesalahan, silakan coba lagi', 'error');
  } finally {
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'Kirim Permintaan';
  }
}

function renderExchangeHistory() {
  const container = document.getElementById('exchange-history');
  if (!container) return;
  
  if (!currentUser) {
    container.innerHTML = '<p class="text-gray-500 text-center py-3 text-xs">Silakan login terlebih dahulu</p>';
    return;
  }
  
  const userExchanges = allExchanges.filter(ex => ex.username === currentUser.username);
  
  if (userExchanges.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-3 text-xs">Belum ada riwayat</p>';
    return;
  }
  
  container.innerHTML = userExchanges.map(ex => {
    const statusClass = ex.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 
                       ex.status === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
    const statusText = ex.status === 'pending' ? 'Pending' : 
                      ex.status === 'success' ? 'Berhasil' : 'Ditolak';
    
    return `
      <div class="p-3 bg-gray-50 rounded-lg">
        <div class="flex items-center justify-between mb-1.5">
          <span class="font-semibold text-gray-800 text-sm">${ex.amount} Poin = Rp ${ex.amount}</span>
          <span class="px-2 py-0.5 ${statusClass} rounded-lg text-xs font-medium">${statusText}</span>
        </div>
        <p class="text-xs text-gray-500">${ex.danaAccount} - ${ex.danaPhone}</p>
        <p class="text-xs text-gray-400 mt-1">${new Date(ex.requestedAt).toLocaleString('id-ID')}</p>
        ${ex.adminNote ? `<p class="text-xs text-blue-600 mt-1.5 p-1.5 bg-blue-50 rounded">ğŸ“ ${ex.adminNote}</p>` : ''}
      </div>
    `;
  }).join('');
}

// ==================== AUTHENTICATION FUNCTIONS ====================
async function handleLogin(e) {
  e.preventDefault();
  
  const btn = document.getElementById('login-btn');
  const btnText = document.getElementById('login-btn-text');
  
  btn.disabled = true;
  btnText.textContent = 'Memproses...';
  
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  
  // Refresh data dari server sebelum login
  await refreshAllData();
  
  const user = allUsers.find(u => 
    u.username.toLowerCase() === username.toLowerCase() && 
    u.password === password
  );
  
  if (!user) {
    showToast('Username atau password salah!', 'error');
    btn.disabled = false;
    btnText.textContent = 'Masuk';
    return;
  }
  
  if (user.blocked) {
    showToast('Akun Anda diblokir!', 'error');
    btn.disabled = false;
    btnText.textContent = 'Masuk';
    return;
  }
  
  user.lastLogin = new Date().toISOString();
  
  const userIndex = allUsers.findIndex(u => u.id === user.id);
  if (userIndex >= 0) {
    allUsers[userIndex] = user;
  }
  
  await syncToGoogle('updateUser', user);
  
  currentUser = user;
  saveSession(user);
  
  btn.disabled = false;
  btnText.textContent = 'Masuk';
  
  afterLogin();
}

async function handleRegister(e) {
  e.preventDefault();
  
  const btn = document.getElementById('register-btn');
  const btnText = document.getElementById('register-btn-text');
  
  btn.disabled = true;
  btnText.textContent = 'Memproses...';
  
  const username = document.getElementById('reg-username').value.trim();
  const password = document.getElementById('reg-password').value;
  const country = document.getElementById('reg-country').value;
  
  if (!username || !password || !country) {
    showToast('Semua field harus diisi!', 'error');
    btn.disabled = false;
    btnText.textContent = 'Daftar';
    return;
  }
  
  // Refresh data dari server untuk mendapatkan data terbaru
  showLoading('Mengecek data dari server...');
  await fetchAllData();
  
  // Cek apakah username sudah ada di database server
  const exists = allUsers.find(u => u.username.toLowerCase() === username.toLowerCase());
  if (exists) {
    showToast('Username sudah digunakan!', 'error');
    btn.disabled = false;
    btnText.textContent = 'Daftar';
    hideLoading();
    return;
  }
  
  // CEK APAKAH SUDAH ADA ADMIN DI DATABASE SERVER
  const hasAdmin = allUsers.some(u => u.role === 'admin');
  
  console.log('Cek admin exists di server:', hasAdmin);
  console.log('Total users di server:', allUsers.length);
  
  // Jika belum ada admin di server, user ini jadi admin. Selain itu jadi user biasa
  const role = !hasAdmin ? 'admin' : 'user';
  
  const newUser = {
    __backendId: 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5),
    username: username,
    password: password,
    role: role,
    country: country,
    deviceId: deviceId,
    points: 0,
    blocked: false,
    createdAt: new Date().toISOString(),
    lastLogin: new Date().toISOString()
  };
  
  console.log('New user created:', newUser);
  console.log('Role assigned:', role);
  
  allUsers.push(newUser);
  
  // Sync ke Google Sheets
  await syncToGoogle('createUser', newUser);
  
  showToast(
    role === 'admin' ? 'Selamat! Anda terdaftar sebagai Admin' : 'Pendaftaran berhasil! Silakan login', 
    'success'
  );
  
  document.getElementById('register-form').reset();
  showPage('login-page');
  
  btn.disabled = false;
  btnText.textContent = 'Daftar';
  hideLoading();
}

function handleLogout() {
  console.log('Logout user:', currentUser?.username);
  
  clearSession();
  currentUser = null;
  
  stopHistoryRefresh();
  stopQuizRefresh();
  
  resetQuizState();
  
  showPage('login-page');
  
  document.getElementById('login-form')?.reset();
  document.getElementById('register-form')?.reset();
  
  showToast('Berhasil logout', 'success');
}

function afterLogin() {
  if (!currentUser) return;
  
  console.log('After login, user:', currentUser);
  console.log('User role:', currentUser.role);
  
  if (appSettings?.maintenanceMode && currentUser.role !== 'admin') {
    showPage('maintenance-page');
    return;
  }
  
  document.getElementById('header-username').textContent = currentUser.username;
  document.getElementById('profile-username').textContent = currentUser.username;
  
  const roleSpan = document.getElementById('profile-role');
  if (currentUser.role === 'admin') {
    roleSpan.innerHTML = 'Admin <span class="admin-badge">ğŸ‘‘</span>';
    roleSpan.className = 'inline-block mt-1.5 px-2.5 py-1 bg-yellow-100 text-yellow-800 rounded-full text-xs font-medium';
  } else {
    roleSpan.textContent = 'User';
    roleSpan.className = 'inline-block mt-1.5 px-2.5 py-1 bg-purple-100 text-purple-600 rounded-full text-xs font-medium';
  }
  
  document.getElementById('profile-country').textContent = currentUser.country || '-';
  document.getElementById('profile-device').textContent = currentUser.deviceId || deviceId;
  
  updatePointsDisplay();
  displayBroadcast();
  
  const settingsNavBtn = document.getElementById('settings-nav-btn');
  if (currentUser.role === 'admin') {
    settingsNavBtn.classList.remove('hidden');
    console.log('Settings button ditampilkan untuk admin');
    
    document.getElementById('maintenance-toggle').checked = appSettings?.maintenanceMode || false;
    document.getElementById('reward-points-input').value = appSettings?.rewardPoints || 50;
  } else {
    settingsNavBtn.classList.add('hidden');
    console.log('Settings button disembunyikan untuk user biasa');
  }
  
  showPage('main-app');
  showSection('quiz');
  generateQuiz();
}

// ==================== DELETE CONFIRMATION FUNCTIONS ====================
function showDeleteConfirm(message, action) {
  document.getElementById('delete-confirm-message').textContent = message;
  pendingDeleteAction = action;
  document.getElementById('confirm-delete-modal').classList.remove('hidden');
}

function closeDeleteModal() {
  document.getElementById('confirm-delete-modal').classList.add('hidden');
  pendingDeleteAction = null;
}

// ==================== ADMIN FUNCTIONS ====================
async function toggleMaintenance() {
  if (!currentUser || currentUser.role !== 'admin') return;
  
  const isEnabled = document.getElementById('maintenance-toggle').checked;
  
  appSettings.maintenanceMode = isEnabled;
  
  await syncToGoogle('updateSettings', appSettings);
  
  showToast(isEnabled ? 'Mode maintenance aktif' : 'Mode maintenance nonaktif', 'success');
}

async function updateRewardPoints() {
  if (!currentUser || currentUser.role !== 'admin') return;
  
  const points = parseInt(document.getElementById('reward-points-input').value) || 50;
  
  appSettings.rewardPoints = points;
  
  await syncToGoogle('updateSettings', appSettings);
  
  showToast('Poin reward berhasil diubah!', 'success');
}

// ==================== USER MANAGEMENT ====================
function renderUserList() {
  const container = document.getElementById('user-list');
  if (!container) return;
  
  const users = allUsers;
  
  document.getElementById('user-count-badge').textContent = `${users.length} Users`;
  
  if (users.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-3 text-xs">Tidak ada user terdaftar</p>';
    return;
  }
  
  container.innerHTML = users.map(user => {
    const isAdmin = user.role === 'admin';
    return `
      <div class="p-3 bg-gray-50 rounded-lg border ${isAdmin ? 'border-yellow-300' : 'border-gray-200'}">
        <div class="flex items-center justify-between mb-2">
          <div>
            <div class="flex items-center gap-2">
              <p class="font-semibold text-gray-800 text-sm">${user.username}</p>
              ${isAdmin ? '<span class="admin-badge">Admin</span>' : ''}
            </div>
            <p class="text-xs text-gray-500">${user.country || '-'}</p>
            <p class="text-xs font-mono text-purple-600 mt-1">ğŸ“± ${user.deviceId || '-'}</p>
            <p class="text-xs text-gray-400 mt-1">Bergabung: ${new Date(user.createdAt).toLocaleString('id-ID')}</p>
          </div>
          <div class="text-right">
            <p class="text-sm font-bold text-green-600">${user.points || 0} Poin</p>
          </div>
        </div>
        <div class="flex gap-1.5 mt-2">
          <button type="button" onclick="openEditUserModal('${user.__backendId || user.id}')" class="flex-1 py-1.5 bg-blue-100 text-blue-700 rounded text-xs font-medium hover:bg-blue-200">Edit Poin</button>
          ${!isAdmin ? `
            <button type="button" onclick="deleteUser('${user.__backendId || user.id}')" class="flex-1 py-1.5 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200">Hapus</button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function openEditUserModal(userId) {
  const user = allUsers.find(u => (u.__backendId || u.id) === userId);
  if (!user) return;
  
  document.getElementById('edit-user-id').value = userId;
  document.getElementById('edit-user-username').value = user.username;
  document.getElementById('edit-user-role').value = user.role === 'admin' ? 'Admin' : 'User';
  document.getElementById('edit-user-device').value = user.deviceId || '-';
  document.getElementById('edit-user-password').value = '';
  document.getElementById('edit-user-current-points').textContent = user.points || 0;
  document.getElementById('edit-user-new-points').value = user.points || 0;
  document.getElementById('edit-user-modal').classList.remove('hidden');
}

function closeEditUserModal() {
  document.getElementById('edit-user-modal').classList.add('hidden');
}

async function saveEditUser(e) {
  e.preventDefault();
  
  const userId = document.getElementById('edit-user-id').value;
  const newPassword = document.getElementById('edit-user-password').value;
  const newPoints = parseInt(document.getElementById('edit-user-new-points').value) || 0;
  
  const user = allUsers.find(u => (u.__backendId || u.id) === userId);
  if (!user) return;
  
  if (newPassword) {
    user.password = newPassword;
  }
  
  user.points = newPoints;
  
  const userIndex = allUsers.findIndex(u => (u.__backendId || u.id) === userId);
  allUsers[userIndex] = user;
  
  await syncToGoogle('updateUser', user);
  
  closeEditUserModal();
  showToast('User berhasil diperbarui!', 'success');
  renderUserList();
  
  if (currentUser && (currentUser.__backendId || currentUser.id) === userId) {
    currentUser.points = newPoints;
    updatePointsDisplay();
  }
}

async function deleteUser(userId) {
  showDeleteConfirm('Apakah Anda yakin ingin menghapus user ini?', async () => {
    const userIndex = allUsers.findIndex(u => (u.__backendId || u.id) === userId);
    if (userIndex >= 0) {
      const user = allUsers[userIndex];
      allUsers.splice(userIndex, 1);
      
      await syncToGoogle('deleteUser', user);
      
      showToast('User berhasil dihapus!', 'success');
      renderUserList();
      closeDeleteModal();
    }
  });
}

// ==================== EXCHANGE MANAGEMENT ====================
function renderAdminExchangeList() {
  const container = document.getElementById('admin-exchange-list');
  if (!container) return;
  
  const exchanges = [...allExchanges].sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));
  
  if (exchanges.length === 0) {
    container.innerHTML = '<p class="text-gray-500 text-center py-3 text-xs">Belum ada permintaan penukaran</p>';
    return;
  }
  
  container.innerHTML = exchanges.map(ex => {
    const statusClass = ex.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 
                       ex.status === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
    const statusText = ex.status === 'pending' ? 'Pending' : 
                      ex.status === 'success' ? 'Berhasil' : 'Ditolak';
    
    return `
      <div class="p-3 bg-gray-50 rounded-lg">
        <div class="flex items-center justify-between mb-1.5">
          <span class="font-semibold text-gray-800 text-sm">${ex.username}</span>
          <span class="px-2 py-0.5 ${statusClass} rounded text-xs font-medium">${statusText}</span>
        </div>
        <div class="flex items-center justify-between mb-1">
          <span class="text-green-600 font-bold text-sm">${ex.amount} Poin</span>
          <span class="text-xs text-gray-400">${new Date(ex.requestedAt).toLocaleString('id-ID')}</span>
        </div>
        <p class="text-xs text-gray-500">${ex.danaAccount} - ${ex.danaPhone}</p>
        ${ex.adminNote ? `<p class="text-xs text-blue-600 mt-1.5 p-1.5 bg-blue-50 rounded">ğŸ“ ${ex.adminNote}</p>` : ''}
        <div class="flex gap-1.5 mt-2">
          <button type="button" onclick="openExchangeStatusModal('${ex.__backendId || ex.id}')" class="flex-1 py-1.5 bg-blue-100 text-blue-700 rounded text-xs font-medium hover:bg-blue-200">Ubah Status</button>
          <button type="button" onclick="deleteExchange('${ex.__backendId || ex.id}')" class="flex-1 py-1.5 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200">Hapus</button>
        </div>
      </div>
    `;
  }).join('');
}

function openExchangeStatusModal(exchangeId) {
  const exchange = allExchanges.find(ex => (ex.__backendId || ex.id) === exchangeId);
  if (!exchange) return;
  
  document.getElementById('exchange-status-id').value = exchangeId;
  document.getElementById('exchange-status-user-id').value = exchange.userId || exchange.username;
  document.getElementById('exchange-status-amount').value = exchange.amount;
  document.getElementById('exchange-status-select').value = exchange.status === 'success' ? 'success' : exchange.status === 'rejected' ? 'rejected' : 'success';
  document.getElementById('exchange-status-note').value = exchange.adminNote || '';
  document.getElementById('exchange-status-modal').classList.remove('hidden');
}

function closeExchangeStatusModal() {
  document.getElementById('exchange-status-modal').classList.add('hidden');
}

async function saveExchangeStatus(e) {
  e.preventDefault();
  
  const exchangeId = document.getElementById('exchange-status-id').value;
  const userId = document.getElementById('exchange-status-user-id').value;
  const amount = parseInt(document.getElementById('exchange-status-amount').value);
  const status = document.getElementById('exchange-status-select').value;
  const note = document.getElementById('exchange-status-note').value;
  
  const exchange = allExchanges.find(ex => (ex.__backendId || ex.id) === exchangeId);
  if (!exchange) return;
  
  const oldStatus = exchange.status;
  
  exchange.status = status;
  exchange.adminNote = note;
  
  if (status === 'rejected' && oldStatus !== 'rejected') {
    const user = allUsers.find(u => u.username === userId || u.id === userId);
    if (user) {
      user.points = (user.points || 0) + amount;
      
      const userIndex = allUsers.findIndex(u => u.username === userId || u.id === userId);
      allUsers[userIndex] = user;
      
      if (currentUser && (currentUser.username === userId || currentUser.id === userId)) {
        currentUser.points = user.points;
        updatePointsDisplay();
      }
      
      await syncToGoogle('updateUser', user);
      showToast(`Poin ${amount} dikembalikan ke user`, 'info');
    }
  }
  
  const exchangeIndex = allExchanges.findIndex(ex => (ex.__backendId || ex.id) === exchangeId);
  allExchanges[exchangeIndex] = exchange;
  
  await syncToGoogle('updateExchange', exchange);
  
  closeExchangeStatusModal();
  showToast(`Status penukaran diubah menjadi ${status === 'success' ? 'Berhasil' : 'Ditolak'}`, 'success');
  renderAdminExchangeList();
  renderExchangeHistory();
}

// ==================== DELETE EXCHANGE FUNCTIONS ====================
async function deleteExchange(exchangeId) {
  showDeleteConfirm('Apakah Anda yakin ingin menghapus riwayat penukaran ini?', async () => {
    const exchangeIndex = allExchanges.findIndex(ex => (ex.__backendId || ex.id) === exchangeId);
    if (exchangeIndex >= 0) {
      const exchange = allExchanges[exchangeIndex];
      
      if (exchange.status === 'pending') {
        const user = allUsers.find(u => u.username === exchange.username);
        if (user) {
          user.points = (user.points || 0) + exchange.amount;
          
          const userIndex = allUsers.findIndex(u => u.username === exchange.username);
          allUsers[userIndex] = user;
          
          if (currentUser && currentUser.username === exchange.username) {
            currentUser.points = user.points;
            updatePointsDisplay();
          }
          
          await syncToGoogle('updateUser', user);
        }
      }
      
      allExchanges.splice(exchangeIndex, 1);
      
      await syncToGoogle('deleteExchange', exchange);
      
      showToast('Riwayat penukaran berhasil dihapus!', 'success');
      renderAdminExchangeList();
      renderExchangeHistory();
      closeDeleteModal();
    }
  });
}

// ==================== CLEAR ALL EXCHANGES ====================
async function clearAllExchanges() {
  showDeleteConfirm('Apakah Anda yakin ingin menghapus SEMUA riwayat penukaran? Tindakan ini tidak dapat dibatalkan!', async () => {
    for (const exchange of allExchanges) {
      if (exchange.status === 'pending') {
        const user = allUsers.find(u => u.username === exchange.username);
        if (user) {
          user.points = (user.points || 0) + exchange.amount;
          
          if (currentUser && currentUser.username === exchange.username) {
            currentUser.points = user.points;
          }
        }
      }
    }
    
    allExchanges = [];
    
    await syncToGoogle('syncExchanges', []);
    await syncToGoogle('syncUsers', allUsers);
    
    if (currentUser) {
      updatePointsDisplay();
    }
    
    showToast('Semua riwayat penukaran telah dihapus!', 'success');
    renderAdminExchangeList();
    renderExchangeHistory();
    closeDeleteModal();
  });
}

// Setup confirm delete button
document.getElementById('confirm-delete-btn').addEventListener('click', function() {
  if (pendingDeleteAction) {
    pendingDeleteAction();
  }
});

// ==================== INITIALIZATION ====================
async function init() {
  console.log('Initializing app...');
  
  showLoading('Memuat data dari server...');
  
  // Ambil data dari server
  await fetchAllData();
  
  if (GAS_URL) {
    console.log('âœ… Google Apps Script URL terkonfigurasi:', GAS_URL);
  } else {
    console.warn('âš ï¸ Google Apps Script URL belum dikonfigurasi!');
  }
  
  if (typeof show_9865183 === 'function') {
    console.log('âœ… Monetag SDK siap digunakan');
  } else {
    console.warn('âš ï¸ Monetag SDK tidak tersedia - menggunakan simulasi');
  }
  
  document.getElementById('reg-country').value = 'Indonesia';
  
  document.getElementById('login-form').addEventListener('submit', handleLogin);
  document.getElementById('register-form').addEventListener('submit', handleRegister);
  document.getElementById('exchange-form').addEventListener('submit', submitExchange);
  document.getElementById('edit-user-form').addEventListener('submit', saveEditUser);
  document.getElementById('exchange-status-form').addEventListener('submit', saveExchangeStatus);
  document.getElementById('broadcast-form').addEventListener('submit', submitBroadcast);
  
  document.getElementById('broadcast-message').addEventListener('input', function(e) {
    document.getElementById('char-count').textContent = e.target.value.length + '/100';
  });
  
  const session = getSession();
  if (session) {
    console.log('Session found:', session);
    const user = allUsers.find(u => u.id === session.userId);
    if (user && !user.blocked) {
      console.log('Auto-login user:', user);
      console.log('User role:', user.role);
      currentUser = user;
      setTimeout(() => {
        hideLoading();
        afterLogin();
      }, 500);
    } else {
      clearSession();
      hideLoading();
    }
  } else {
    console.log('No valid session');
    hideLoading();
  }
  
  const adminCount = allUsers.filter(u => u.role === 'admin').length;
  console.log('Total users dari server:', allUsers.length);
  console.log('Total admins dari server:', adminCount);
}

// Start the application
init();
</script>
</body>
</html>
