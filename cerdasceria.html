<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Math Quiz App</title>
  <script src="https://cdn.tailwindcss.com/3.4.17"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="//libtl.com/sdk.js" data-zone="10547702" data-sdk="show_10547702"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        * { font-family: 'Poppins', sans-serif; }
        html, body { height: 100%; width: 100%; margin: 0; padding: 0; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-shadow { box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .toast { animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s; }
        @keyframes slideIn { from { transform: translateY(-100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); transition: all 0.3s; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
        .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .menu-active { background: rgba(102,126,234,0.1); color: #667eea; }
        .input-field { transition: all 0.3s; border: 1.5px solid #e2e8f0; }
        .input-field:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1); }
        .page { display: none !important; }
        .page.active { display: block !important; }
        .loading-spinner { border: 2px solid #f3f3f3; border-top: 2px solid #667eea; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .auth-container { display: flex; align-items: center; justify-content: center; min-height: 100%; }
        .point-change { animation: pointPulse 0.5s ease; }
        @keyframes pointPulse { 0% { transform: scale(1); } 50% { transform: scale(1.15); } 100% { transform: scale(1); } }
        .pulse-animation { animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .broadcast-banner {
            background: linear-gradient(90deg, #ff6b6b 0%, #ff8e72 100%);
            color: white;
            padding: 12px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 16px;
            position: relative;
        }
        .broadcast-text {
            animation: scrollText 15s linear infinite;
            white-space: nowrap;
            font-weight: 600;
            font-size: 14px;
            display: inline-block;
        }
        @keyframes scrollText {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        .broadcast-banner.paused .broadcast-text {
            animation-play-state: paused;
        }
        #main-app { display: flex; flex-direction: column; }
        main { padding-bottom: 100px; }
    </style>
  <style>body { box-sizing: border-box; }</style>
 </head>
 <body class="bg-gray-50">
  <div id="app" class="w-full h-full overflow-auto"><!-- Toast Container -->
   <div id="toast-container" class="fixed top-4 left-1/2 transform -translate-x-1/2 z-50"></div><!-- Login Page -->
   <div id="login-page" class="page active w-full h-full">
    <div class="auth-container">
     <div class="w-full max-w-sm px-4">
      <div class="text-center mb-6">
       <h1 id="app-title" class="text-3xl font-bold text-gray-800">Math Quiz</h1>
       <p class="text-sm text-gray-500 mt-1">Jawab quiz &amp; dapatkan reward!</p>
      </div>
      <div class="bg-white rounded-2xl p-6 card-shadow">
       <form id="login-form" class="space-y-3">
        <div><label class="block text-xs font-semibold text-gray-700 mb-2">Username</label> <input type="text" id="login-username" class="input-field w-full px-3 py-2.5 rounded-lg outline-none text-sm" placeholder="Masukkan username" required>
        </div>
        <div><label class="block text-xs font-semibold text-gray-700 mb-2">Password</label> <input type="password" id="login-password" class="input-field w-full px-3 py-2.5 rounded-lg outline-none text-sm" placeholder="Masukkan password" required>
        </div><button type="submit" class="btn-primary w-full py-2.5 rounded-lg text-white font-semibold text-sm mt-4"> <span id="login-btn-text">Masuk</span> </button>
       </form>
       <p class="text-center mt-4 text-gray-500 text-xs">Belum punya akun? <button type="button" onclick="showPage('register-page')" class="text-purple-600 font-semibold hover:underline">Daftar</button></p>
      </div>
     </div>
    </div>
   </div><!-- Register Page -->
   <div id="register-page" class="page w-full h-full">
    <div class="auth-container">
     <div class="w-full max-w-sm px-4">
      <div class="text-center mb-6">
       <h1 class="text-3xl font-bold text-gray-800">Daftar Akun</h1>
       <p class="text-sm text-gray-500 mt-1">Buat akun baru untuk mulai bermain</p>
      </div>
      <div class="bg-white rounded-2xl p-6 card-shadow">
       <form id="register-form" class="space-y-3">
        <div><label class="block text-xs font-semibold text-gray-700 mb-2">Username</label> <input type="text" id="reg-username" class="input-field w-full px-3 py-2.5 rounded-lg outline-none text-sm" placeholder="Pilih username" required>
        </div>
        <div><label class="block text-xs font-semibold text-gray-700 mb-2">Password</label> <input type="password" id="reg-password" class="input-field w-full px-3 py-2.5 rounded-lg outline-none text-sm" placeholder="Buat password" required>
        </div>
        <div><label class="block text-xs font-semibold text-gray-700 mb-2">Negara</label>
         <div class="relative"><select id="reg-country" class="input-field w-full px-3 py-2.5 rounded-lg outline-none bg-white text-sm" required> <option value="">ğŸ” Mendeteksi lokasi...</option> <option value="Indonesia">ğŸ‡®ğŸ‡© Indonesia</option> <option value="Malaysia">ğŸ‡²ğŸ‡¾ Malaysia</option> <option value="Singapore">ğŸ‡¸ğŸ‡¬ Singapore</option> <option value="Thailand">ğŸ‡¹ğŸ‡­ Thailand</option> <option value="Vietnam">ğŸ‡»ğŸ‡³ Vietnam</option> <option value="Philippines">ğŸ‡µğŸ‡­ Philippines</option> </select>
         </div>
        </div><button type="submit" class="btn-primary w-full py-2.5 rounded-lg text-white font-semibold text-sm mt-4"> <span id="reg-btn-text">Daftar</span> </button>
       </form>
       <p class="text-center mt-4 text-gray-500 text-xs">Sudah punya akun? <button type="button" onclick="showPage('login-page')" class="text-purple-600 font-semibold hover:underline">Masuk</button></p>
      </div>
     </div>
    </div>
   </div><!-- Maintenance Page -->
   <div id="maintenance-page" class="page w-full h-full">
    <div class="auth-container">
     <div class="text-center px-4">
      <div class="w-20 h-20 bg-yellow-100 rounded-full mx-auto mb-4 flex items-center justify-center"><span class="text-3xl">ğŸ”§</span>
      </div>
      <h1 class="text-2xl font-bold text-gray-800 mb-2">Maintenance</h1>
      <p class="text-gray-500 max-w-xs text-sm">Aplikasi sedang dalam perbaikan. Silakan kembali beberapa saat lagi.</p><button type="button" onclick="handleLogout()" class="mt-6 px-4 py-2 bg-gray-200 rounded-lg text-gray-700 font-semibold hover:bg-gray-300 transition text-sm"> Logout </button>
     </div>
    </div>
   </div><!-- Main App Container -->
   <div id="main-app" class="page w-full h-full"><!-- Header -->
    <header class="gradient-bg text-white p-3 sticky top-0 z-40">
     <div class="max-w-2xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-2">
       <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center"><span class="text-sm">ğŸ‘¤</span>
       </div>
       <div>
        <p id="header-username" class="font-semibold text-sm">Username</p>
        <p id="header-points" class="text-xs opacity-80">0 Poin</p>
       </div>
      </div><button type="button" onclick="handleLogout()" class="px-3 py-1.5 bg-white/20 rounded-lg hover:bg-white/30 transition text-xs font-medium"> Logout </button>
     </div>
    </header><!-- Content Area -->
    <main class="flex-1 p-3 overflow-auto">
     <div class="max-w-2xl mx-auto"><!-- Broadcast Banner -->
      <div id="broadcast-container" class="hidden">
       <div class="broadcast-banner" onmouseenter="this.classList.add('paused')" onmouseleave="this.classList.remove('paused')"><span class="broadcast-text" id="broadcast-text-display">ğŸ“¢ </span>
       </div>
      </div><!-- Quiz Section -->
      <div id="quiz-section" class="section">
       <div class="bg-white rounded-2xl p-4 card-shadow mb-3">
        <div class="flex items-center justify-between mb-4">
         <h2 class="text-lg font-bold text-gray-800">ğŸ¯ Quiz Matematika</h2>
         <div class="px-3 py-1.5 bg-purple-100 rounded-lg"><span id="quiz-points" class="font-bold text-purple-600 text-sm">0 Poin</span>
         </div>
        </div>
        <div id="quiz-container">
         <div class="text-center py-6 bg-gradient-to-br from-purple-50 to-blue-50 rounded-xl mb-4">
          <p class="text-gray-500 mb-1 text-xs">Berapa hasil dari:</p>
          <p id="quiz-question" class="text-3xl font-bold text-gray-800">0 + 0 = ?</p>
         </div>
         <div id="quiz-options" class="grid grid-cols-2 gap-2 mb-4"><!-- Options will be generated -->
         </div>
         <div id="claim-reward-container" class="hidden"><button type="button" id="claim-reward-btn" onclick="claimReward()" class="btn-success w-full py-3 rounded-lg text-white font-bold text-sm flex items-center justify-center gap-2"> <span>ğŸ</span> <span>Klaim Reward</span> </button>
         </div>
        </div>
       </div>
      </div><!-- History Section -->
      <div id="history-section" class="section hidden">
       <div class="bg-white rounded-2xl p-4 card-shadow mb-3">
        <div class="flex items-center justify-between mb-4">
         <div class="flex items-center gap-2">
          <h2 class="text-lg font-bold text-gray-800">ğŸ’° Poin Saya</h2><span id="refresh-indicator" class="text-xs text-green-600 opacity-0">ğŸ”„ Auto-refresh</span>
         </div>
         <div class="px-3 py-1.5 bg-green-100 rounded-lg"><span id="history-points" class="font-bold text-green-600 text-sm">0 Poin</span>
         </div>
        </div><button type="button" onclick="showExchangeForm()" class="btn-primary w-full py-2.5 rounded-lg text-white font-semibold text-sm mb-3"> Tukar Poin </button>
        <p class="text-xs text-gray-500 text-center">Minimal: 50 Poin = Rp 50</p>
       </div><!-- Exchange Form -->
       <div id="exchange-form-container" class="bg-white rounded-2xl p-4 card-shadow mb-3 hidden">
        <h3 class="text-base font-bold text-gray-800 mb-3">ğŸ“ Form Penukaran</h3>
        <form id="exchange-form" class="space-y-2.5">
         <div><label class="block text-xs font-semibold text-gray-700 mb-1.5">Jumlah Poin</label> <input type="number" id="exchange-amount" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="Min. 50 poin" min="50" required>
         </div>
         <div><label class="block text-xs font-semibold text-gray-700 mb-1.5">Nama Akun DANA</label> <input type="text" id="dana-account" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="Nama lengkap" required>
         </div>
         <div><label class="block text-xs font-semibold text-gray-700 mb-1.5">Nomor HP DANA</label> <input type="tel" id="dana-phone" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="08xxxxxxxxxx" required>
         </div>
         <div class="flex gap-2 pt-2"><button type="button" onclick="hideExchangeForm()" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-700 font-semibold text-xs">Batal</button> <button type="submit" class="flex-1 btn-primary py-2 rounded-lg text-white font-semibold text-xs">Kirim</button>
         </div>
        </form>
       </div><!-- Exchange History -->
       <div class="bg-white rounded-2xl p-4 card-shadow">
        <h3 class="text-base font-bold text-gray-800 mb-3">ğŸ“‹ Riwayat Penukaran</h3>
        <div id="exchange-history" class="space-y-2">
         <p class="text-gray-500 text-center py-3 text-xs">Belum ada riwayat</p>
        </div>
       </div>
      </div><!-- Profile Section -->
      <div id="profile-section" class="section hidden">
       <div class="bg-white rounded-2xl p-4 card-shadow">
        <div class="text-center mb-4">
         <div class="w-16 h-16 gradient-bg rounded-full mx-auto mb-3 flex items-center justify-center"><span class="text-2xl">ğŸ‘¤</span>
         </div>
         <h2 id="profile-username" class="text-xl font-bold text-gray-800">Username</h2><span id="profile-role" class="inline-block mt-1.5 px-2.5 py-1 bg-purple-100 text-purple-600 rounded-full text-xs font-medium">User</span>
        </div>
        <div class="space-y-2">
         <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span class="text-gray-600 text-sm">ğŸŒ Negara</span> <span id="profile-country" class="font-semibold text-gray-800 text-sm">-</span>
         </div>
         <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span class="text-gray-600 text-sm">ğŸ“± Device ID</span> <span id="profile-device" class="font-semibold text-gray-800 text-xs">-</span>
         </div>
         <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span class="text-gray-600 text-sm">ğŸ’° Total Poin</span> <span id="profile-points" class="font-semibold text-green-600">0</span>
         </div>
        </div>
       </div>
      </div><!-- Settings Section (Admin Only) -->
      <div id="settings-section" class="section hidden">
       <div class="space-y-3"><!-- Google Apps Script Status -->
        <div class="bg-white rounded-2xl p-4 card-shadow">
         <h2 class="text-lg font-bold text-gray-800 mb-3">â˜ï¸ Database Status</h2>
         <div class="space-y-2">
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span class="text-gray-600 text-sm">ğŸ”— Koneksi Google Sheets</span> <span id="connection-status" class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs font-medium">âœ“ Connected</span>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span class="text-gray-600 text-sm">ğŸ“Š Total Records</span> <span class="font-semibold text-gray-800 text-sm" id="total-records">0</span>
          </div>
          <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><span class="text-gray-600 text-sm">â±ï¸ Last Sync</span> <span class="font-semibold text-gray-800 text-sm" id="last-sync">Baru saja</span>
          </div>
         </div><button type="button" onclick="syncDataNow()" class="btn-success w-full py-2.5 rounded-lg text-white font-semibold text-sm mt-3"> ğŸ”„ Sync Data Sekarang </button>
        </div><!-- Broadcast Message -->
        <div class="bg-white rounded-2xl p-4 card-shadow">
         <h2 class="text-lg font-bold text-gray-800 mb-3">ğŸ“¢ Pesan Broadcast</h2>
         <form id="broadcast-form" class="space-y-2.5">
          <div><label class="block text-xs font-semibold text-gray-700 mb-1.5">Pesan</label> <textarea id="broadcast-message" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" rows="3" placeholder="Ketik pesan untuk semua user..." required maxlength="100"></textarea>
           <p id="char-count" class="text-xs text-gray-500 mt-1">0/100</p>
          </div><button type="submit" class="btn-primary w-full py-2.5 rounded-lg text-white font-semibold text-sm flex items-center justify-center gap-2"> <span>ğŸ“¤</span> <span>Kirim Broadcast</span> </button>
         </form>
        </div><!-- Admin Info -->
        <div class="bg-white rounded-2xl p-4 card-shadow">
         <h2 class="text-lg font-bold text-gray-800 mb-3">âš™ï¸ Pengaturan Admin</h2><!-- Maintenance Toggle -->
         <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg mb-3">
          <div>
           <p class="font-semibold text-gray-800 text-sm">Mode Maintenance</p>
           <p class="text-xs text-gray-500">Nonaktifkan akses user</p>
          </div><label class="relative inline-flex items-center cursor-pointer"> <input type="checkbox" id="maintenance-toggle" class="sr-only peer" onchange="toggleMaintenance()">
           <div class="w-12 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[4px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label>
         </div><!-- Reward Points Setting -->
         <div class="p-3 bg-gray-50 rounded-lg">
          <p class="font-semibold text-gray-800 text-sm mb-2">Poin Reward per Klaim</p>
          <div class="flex gap-2"><input type="number" id="reward-points-input" class="input-field flex-1 px-3 py-2 rounded-lg outline-none text-sm" value="50" min="1"> <button type="button" onclick="updateRewardPoints()" class="px-3 py-2 btn-primary rounded-lg text-white font-semibold text-xs">Simpan</button>
          </div>
         </div>
        </div><!-- User Management -->
        <div class="bg-white rounded-2xl p-4 card-shadow">
         <h3 class="text-base font-bold text-gray-800 mb-3">ğŸ‘¥ Manajemen User</h3>
         <div id="user-list" class="space-y-2">
          <p class="text-gray-500 text-center py-3 text-xs">Memuat data...</p>
         </div>
        </div><!-- Exchange Requests -->
        <div class="bg-white rounded-2xl p-4 card-shadow">
         <h3 class="text-base font-bold text-gray-800 mb-3">ğŸ’³ Riwayat Penukaran</h3>
         <div id="admin-exchange-list" class="space-y-2">
          <p class="text-gray-500 text-center py-3 text-xs">Belum ada permintaan</p>
         </div>
        </div>
       </div>
      </div>
     </div>
    </main><!-- Bottom Navigation -->
    <nav class="bg-white border-t border-gray-200 px-4 py-2 mt-auto">
     <div class="flex justify-around max-w-2xl mx-auto"><button type="button" onclick="showSection('quiz')" class="nav-btn flex flex-col items-center p-1.5 rounded-lg transition text-center" data-section="quiz"> <span class="text-xl">ğŸ¯</span> <span class="text-xs font-medium text-gray-600">Quiz</span> </button> <button type="button" onclick="showSection('history')" class="nav-btn flex flex-col items-center p-1.5 rounded-lg transition text-center" data-section="history"> <span class="text-xl">ğŸ“‹</span> <span class="text-xs font-medium text-gray-600">Riwayat</span> </button> <button type="button" onclick="showSection('profile')" class="nav-btn flex flex-col items-center p-1.5 rounded-lg transition text-center" data-section="profile"> <span class="text-xl">ğŸ‘¤</span> <span class="text-xs font-medium text-gray-600">Profil</span> </button> <button id="settings-nav-btn" type="button" onclick="showSection('settings')" class="nav-btn flex flex-col items-center p-1.5 rounded-lg transition hidden text-center" data-section="settings"> <span class="text-xl">âš™ï¸</span> <span class="text-xs font-medium text-gray-600">Setting</span> </button>
     </div>
    </nav>
   </div><!-- Edit User Modal -->
   <div id="edit-user-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-4 w-full max-w-sm max-h-[90%] overflow-auto">
     <h3 class="text-lg font-bold text-gray-800 mb-3">Edit User</h3>
     <form id="edit-user-form" class="space-y-2.5"><input type="hidden" id="edit-user-id">
      <div><label class="block text-xs font-semibold text-gray-700 mb-1.5">Username</label> <input type="text" id="edit-user-username" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" readonly>
      </div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-1.5">Password Baru</label> <input type="password" id="edit-user-password" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="Kosongkan jika tidak diubah">
      </div>
      <div class="p-3 bg-blue-50 rounded-lg">
       <p class="text-xs font-semibold text-gray-700 mb-1.5">Poin Saat Ini</p>
       <p id="edit-user-current-points" class="text-xl font-bold text-blue-600">0</p>
      </div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-1.5">Total Poin Baru</label> <input type="number" id="edit-user-new-points" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" placeholder="0" min="0">
      </div>
      <div class="flex gap-2 pt-2"><button type="button" onclick="closeEditUserModal()" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-700 font-semibold text-xs">Batal</button> <button type="submit" class="flex-1 btn-primary py-2 rounded-lg text-white font-semibold text-xs">Simpan</button>
      </div>
     </form>
    </div>
   </div><!-- Exchange Status Modal -->
   <div id="exchange-status-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-2xl p-4 w-full max-w-sm">
     <h3 class="text-lg font-bold text-gray-800 mb-3">Ubah Status Penukaran</h3>
     <form id="exchange-status-form" class="space-y-2.5"><input type="hidden" id="exchange-status-id"> <input type="hidden" id="exchange-status-user-id"> <input type="hidden" id="exchange-status-amount">
      <div><label class="block text-xs font-semibold text-gray-700 mb-1.5">Status</label> <select id="exchange-status-select" class="input-field w-full px-3 py-2 rounded-lg outline-none bg-white text-sm" required> <option value="success">Berhasil</option> <option value="rejected">Tolak</option> </select>
      </div>
      <div><label class="block text-xs font-semibold text-gray-700 mb-1.5">Catatan Admin</label> <textarea id="exchange-status-note" class="input-field w-full px-3 py-2 rounded-lg outline-none text-sm" rows="2" placeholder="Tambahkan catatan..."></textarea>
      </div>
      <div class="flex gap-2 pt-2"><button type="button" onclick="closeExchangeStatusModal()" class="flex-1 py-2 bg-gray-200 rounded-lg text-gray-700 font-semibold text-xs">Batal</button> <button type="submit" class="flex-1 btn-primary py-2 rounded-lg text-white font-semibold text-xs">Simpan</button>
      </div>
     </form>
    </div>
   </div>
  </div>
  <script>
        // App State
        let currentUser = null;
        let allUsers = [];
        let allExchanges = [];
        let allBroadcasts = [];
        let appSettings = null;
        let currentQuiz = null;
        let isAnswerCorrect = false;
        let historyRefreshInterval = null;
        let detectedCountry = null;
        let currentBroadcast = null;
        let gasWebAppUrl = 'https://script.google.com/macros/s/AKfycbzqdAFW6jru6IUGvcuWZb5Lk9eebAhfg8FoPo60d4H0kkPww3VZEIJ-J2JeLS5Npc_Iww/exec';
        let lastSyncTime = new Date();

        // Default Config
        const defaultConfig = {
            app_title: 'Math Quiz'
        };

        // Generate Device ID
        function generateDeviceId() {
            const stored = localStorage.getItem('deviceId');
            if (stored) return stored;
            const id = 'DEV-' + Math.random().toString(36).substring(2, 10).toUpperCase();
            localStorage.setItem('deviceId', id);
            return id;
        }

        const deviceId = generateDeviceId();

        // Detect Country by IP
        async function detectCountry() {
            try {
                const countryMap = {
                    'ID': 'Indonesia',
                    'MY': 'Malaysia',
                    'SG': 'Singapore',
                    'TH': 'Thailand',
                    'VN': 'Vietnam',
                    'PH': 'Philippines'
                };

                try {
                    const response = await fetch('https://ipapi.co/json/', { 
                        signal: AbortSignal.timeout(3000)
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.country_code && countryMap[data.country_code]) {
                            const country = countryMap[data.country_code];
                            detectedCountry = country;
                            document.getElementById('reg-country').value = country;
                            return;
                        }
                    }
                } catch (e) {
                    console.warn('Country detection fallback...');
                }
            } catch (e) {
                console.error('Country detection error:', e);
            }
        }

        // Session Management
        function saveSession(user) {
            const session = {
                userId: user.__backendId,
                username: user.username,
                role: user.role,
                loginTime: new Date().toISOString()
            };
            localStorage.setItem('userSession', JSON.stringify(session));
        }

        function getSession() {
            const session = localStorage.getItem('userSession');
            if (!session) return null;
            
            const parsed = JSON.parse(session);
            const loginTime = new Date(parsed.loginTime);
            const now = new Date();
            const diffDays = (now - loginTime) / (1000 * 60 * 60 * 24);
            
            if (diffDays >= 2) {
                localStorage.removeItem('userSession');
                return null;
            }
            return parsed;
        }

        function clearSession() {
            localStorage.removeItem('userSession');
        }

        // Toast Notification
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            toast.className = `toast ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg font-medium text-sm`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
        }

        // Section Navigation
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(`${section}-section`).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('menu-active');
                if (btn.dataset.section === section) {
                    btn.classList.add('menu-active');
                }
            });

            stopHistoryRefresh();
            
            if (section === 'history') {
                renderExchangeHistory();
                startHistoryRefresh();
            } else if (section === 'settings') {
                renderUserList();
                renderAdminExchangeList();
                updateDatabaseStatus();
            }
        }

        // History Auto-Refresh
        function startHistoryRefresh() {
            const indicator = document.getElementById('refresh-indicator');
            indicator.classList.remove('opacity-0');
            
            if (historyRefreshInterval) clearInterval(historyRefreshInterval);
            historyRefreshInterval = setInterval(() => {
                renderExchangeHistory();
            }, 5000);
        }

        function stopHistoryRefresh() {
            if (historyRefreshInterval) {
                clearInterval(historyRefreshInterval);
                historyRefreshInterval = null;
            }
            const indicator = document.getElementById('refresh-indicator');
            indicator.classList.add('opacity-0');
        }

        // Broadcast Banner
        function displayBroadcast() {
            const latestBroadcast = allBroadcasts
                .filter(b => b.type === 'broadcast')
                .sort((a, b) => new Date(b.sentAt) - new Date(a.sentAt))[0];
            
            if (latestBroadcast) {
                currentBroadcast = latestBroadcast;
                const container = document.getElementById('broadcast-container');
                const textDisplay = document.getElementById('broadcast-text-display');
                textDisplay.textContent = 'ğŸ“¢ ' + latestBroadcast.message;
                container.classList.remove('hidden');
            }
        }

        // Google Apps Script Integration
        async function sendDataToGAS(action, data) {
            try {
                if (!gasWebAppUrl) {
                    console.log('GAS URL not configured, skipping sync');
                    return;
                }

                const response = await fetch(gasWebAppUrl, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        action: action,
                        data: data,
                        timestamp: new Date().toISOString()
                    })
                });

                lastSyncTime = new Date();
                return true;
            } catch (e) {
                console.error('GAS sync error:', e);
                return false;
            }
        }

        async function syncDataNow() {
            const btn = event.target;
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';

            try {
                // Sync all data types
                await sendDataToGAS('syncUsers', allUsers);
                await sendDataToGAS('syncExchanges', allExchanges);
                await sendDataToGAS('syncBroadcasts', allBroadcasts);
                await sendDataToGAS('syncSettings', [appSettings]);

                showToast('âœ… Data berhasil disync ke Google Sheets!', 'success');
                updateDatabaseStatus();
            } catch (e) {
                showToast('âŒ Gagal sync data: ' + e.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ğŸ”„ Sync Data Sekarang';
            }
        }

        function updateDatabaseStatus() {
            const totalRecords = allUsers.length + allExchanges.length + allBroadcasts.length + (appSettings ? 1 : 0);
            document.getElementById('total-records').textContent = totalRecords;
            
            const syncTime = lastSyncTime.toLocaleTimeString('id-ID');
            document.getElementById('last-sync').textContent = syncTime;
        }

        // Quiz Logic
        function generateQuiz() {
            const a = Math.floor(Math.random() * 100) + 1;
            const b = Math.floor(Math.random() * 100) + 1;
            const correct = a + b;
            
            const options = [correct];
            while (options.length < 4) {
                const wrong = correct + Math.floor(Math.random() * 21) - 10;
                if (wrong !== correct && wrong > 0 && !options.includes(wrong)) {
                    options.push(wrong);
                }
            }
            
            for (let i = options.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [options[i], options[j]] = [options[j], options[i]];
            }
            
            currentQuiz = { a, b, correct, options };
            renderQuiz();
        }

        function renderQuiz() {
            if (!currentQuiz) return;
            
            document.getElementById('quiz-question').textContent = `${currentQuiz.a} + ${currentQuiz.b} = ?`;
            
            const optionsContainer = document.getElementById('quiz-options');
            optionsContainer.innerHTML = currentQuiz.options.map(opt => `
                <button type="button" onclick="checkAnswer(${opt})" class="p-3 bg-gray-100 hover:bg-purple-100 rounded-lg text-lg font-bold text-gray-800 transition">
                    ${opt}
                </button>
            `).join('');
            
            document.getElementById('claim-reward-container').classList.add('hidden');
            isAnswerCorrect = false;
        }

        function checkAnswer(answer) {
            if (answer === currentQuiz.correct) {
                showToast('ğŸ‰ Jawaban Benar!', 'success');
                isAnswerCorrect = true;
                document.getElementById('claim-reward-container').classList.remove('hidden');
            } else {
                showToast('âŒ Jawaban Salah!', 'error');
                setTimeout(generateQuiz, 1000);
            }
        }

        async function claimReward() {
            if (!isAnswerCorrect || !currentUser) return;
            
            const btn = document.getElementById('claim-reward-btn');
            btn.disabled = true;
            btn.innerHTML = '<div class="loading-spinner mx-auto"></div>';
            
            try {
                if (typeof show_10547702 === 'function') {
                    await show_10547702();
                }
                
                const rewardAmount = appSettings?.rewardPoints || 50;
                currentUser.points = (currentUser.points || 0) + rewardAmount;
                
                const updateResult = await window.dataSdk.update(currentUser);
                if (updateResult.isOk) {
                    showToast(`+${rewardAmount} Poin!`, 'success');
                    updatePointsDisplay();
                    
                    // Sync to GAS
                    await sendDataToGAS('updateUser', currentUser);
                }
                
                generateQuiz();
            } catch (e) {
                const rewardAmount = appSettings?.rewardPoints || 50;
                currentUser.points = (currentUser.points || 0) + rewardAmount;
                await window.dataSdk.update(currentUser);
                showToast(`+${rewardAmount} Poin!`, 'success');
                updatePointsDisplay();
                generateQuiz();
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<span>ğŸ</span><span>Klaim Reward</span>';
            }
        }

        function updatePointsDisplay() {
            if (!currentUser) return;
            const points = currentUser.points || 0;
            
            const pointsElements = [
                document.getElementById('header-points'),
                document.getElementById('quiz-points'),
                document.getElementById('history-points'),
                document.getElementById('profile-points')
            ];
            
            pointsElements.forEach(el => {
                if (el) {
                    el.classList.remove('point-change');
                    void el.offsetWidth;
                    el.classList.add('point-change');
                }
            });
            
            document.getElementById('header-points').textContent = `${points} Poin`;
            document.getElementById('quiz-points').textContent = `${points} Poin`;
            document.getElementById('history-points').textContent = `${points} Poin`;
            document.getElementById('profile-points').textContent = points;
        }

        // Exchange Functions
        function showExchangeForm() {
            document.getElementById('exchange-form-container').classList.remove('hidden');
        }

        function hideExchangeForm() {
            document.getElementById('exchange-form-container').classList.add('hidden');
            document.getElementById('exchange-form').reset();
        }

        async function submitExchange(e) {
            e.preventDefault();
            
            const amount = parseInt(document.getElementById('exchange-amount').value);
            const danaAccount = document.getElementById('dana-account').value;
            const danaPhone = document.getElementById('dana-phone').value;
            
            if (amount < 50) {
                showToast('Minimal penukaran 50 poin!', 'error');
                return;
            }
            
            if ((currentUser.points || 0) < amount) {
                showToast('Poin tidak mencukupi!', 'error');
                return;
            }
            
            currentUser.points = (currentUser.points || 0) - amount;
            await window.dataSdk.update(currentUser);
            
            const exchange = {
                type: 'exchange',
                exchangeId: 'EX-' + Date.now(),
                userId: currentUser.__backendId,
                username: currentUser.username,
                amount: amount,
                danaAccount: danaAccount,
                danaPhone: danaPhone,
                status: 'pending',
                adminNote: '',
                requestedAt: new Date().toISOString()
            };
            
            await window.dataSdk.create(exchange);
            
            // Sync to GAS
            await sendDataToGAS('createExchange', exchange);
            await sendDataToGAS('updateUser', currentUser);
            
            hideExchangeForm();
            updatePointsDisplay();
            showToast('Permintaan penukaran berhasil!', 'success');
            
            try {
                if (typeof show_10547702 === 'function') {
                    await show_10547702();
                }
            } catch (e) {}
            
            renderExchangeHistory();
        }

        function renderExchangeHistory() {
            const container = document.getElementById('exchange-history');
            const userExchanges = allExchanges.filter(ex => ex.userId === currentUser?.__backendId);
            
            if (userExchanges.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-3 text-xs">Belum ada riwayat</p>';
                return;
            }
            
            container.innerHTML = userExchanges.map(ex => {
                const statusClass = ex.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 
                                   ex.status === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const statusText = ex.status === 'pending' ? 'Pending' : 
                                  ex.status === 'success' ? 'Berhasil' : 'Ditolak';
                
                return `
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between mb-1.5">
                            <span class="font-semibold text-gray-800 text-sm">${ex.amount} Poin = Rp ${ex.amount}</span>
                            <span class="px-2 py-0.5 ${statusClass} rounded-lg text-xs font-medium">${statusText}</span>
                        </div>
                        <p class="text-xs text-gray-500">${ex.danaAccount} - ${ex.danaPhone}</p>
                        <p class="text-xs text-gray-400 mt-1">${new Date(ex.requestedAt).toLocaleString('id-ID')}</p>
                        ${ex.adminNote ? `<p class="text-xs text-blue-600 mt-1.5 p-1.5 bg-blue-50 rounded">ğŸ“ ${ex.adminNote}</p>` : ''}
                        ${ex.status === 'pending' ? `
                            <button type="button" onclick="deleteUserExchange('${ex.__backendId}')" class="mt-1.5 text-xs text-red-500 hover:underline">Hapus</button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        async function deleteUserExchange(exchangeId) {
            const exchange = allExchanges.find(ex => ex.__backendId === exchangeId);
            if (!exchange || exchange.status !== 'pending') return;
            
            currentUser.points = (currentUser.points || 0) + exchange.amount;
            await window.dataSdk.update(currentUser);
            await window.dataSdk.delete(exchange);
            
            // Sync to GAS
            await sendDataToGAS('deleteExchange', exchange);
            await sendDataToGAS('updateUser', currentUser);
            
            showToast('Permintaan dibatalkan, poin dikembalikan', 'success');
            updatePointsDisplay();
        }

        // Broadcast Functions
        async function submitBroadcast(e) {
            e.preventDefault();
            
            const message = document.getElementById('broadcast-message').value.trim();
            
            if (!message) {
                showToast('Pesan tidak boleh kosong!', 'error');
                return;
            }
            
            const broadcast = {
                type: 'broadcast',
                messageId: 'BC-' + Date.now(),
                message: message,
                sentAt: new Date().toISOString()
            };
            
            await window.dataSdk.create(broadcast);
            
            // Sync to GAS
            await sendDataToGAS('createBroadcast', broadcast);
            
            document.getElementById('broadcast-form').reset();
            document.getElementById('char-count').textContent = '0/100';
            showToast('Pesan broadcast berhasil dikirim!', 'success');
        }

        // Update char count
        document.addEventListener('input', function(e) {
            if (e.target.id === 'broadcast-message') {
                const count = e.target.value.length;
                document.getElementById('char-count').textContent = `${count}/100`;
            }
        });

        // Admin Functions
        async function toggleMaintenance() {
            const isEnabled = document.getElementById('maintenance-toggle').checked;
            
            if (!appSettings) {
                appSettings = {
                    type: 'settings',
                    maintenanceMode: isEnabled,
                    rewardPoints: 50
                };
                await window.dataSdk.create(appSettings);
            } else {
                appSettings.maintenanceMode = isEnabled;
                await window.dataSdk.update(appSettings);
            }
            
            // Sync to GAS
            await sendDataToGAS('updateSettings', appSettings);
            
            if (isEnabled) {
                const session = getSession();
                if (session && session.role !== 'admin') {
                    clearSession();
                    showToast('Aplikasi sedang maintenance', 'info');
                    setTimeout(() => {
                        handleLogout();
                    }, 500);
                    return;
                }
                
                showToast('Mode maintenance aktif - semua user di-logout', 'success');
            } else {
                showToast('Mode maintenance nonaktif', 'success');
            }
        }

        async function updateRewardPoints() {
            const points = parseInt(document.getElementById('reward-points-input').value) || 50;
            
            if (!appSettings) {
                appSettings = {
                    type: 'settings',
                    maintenanceMode: false,
                    rewardPoints: points
                };
                await window.dataSdk.create(appSettings);
            } else {
                appSettings.rewardPoints = points;
                await window.dataSdk.update(appSettings);
            }
            
            // Sync to GAS
            await sendDataToGAS('updateSettings', appSettings);
            
            showToast('Poin reward berhasil diubah!', 'success');
        }

        function renderUserList() {
            const container = document.getElementById('user-list');
            const users = allUsers.filter(u => u.type === 'user');
            
            if (users.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-3 text-xs">Tidak ada user terdaftar</p>';
                return;
            }
            
            container.innerHTML = users.map(user => {
                const isBlocked = user.blocked;
                return `
                    <div class="p-3 bg-gray-50 rounded-lg ${isBlocked ? 'opacity-50' : ''}">
                        <div class="flex items-center justify-between mb-2">
                            <div>
                                <p class="font-semibold text-gray-800 text-sm">${user.username}</p>
                                <p class="text-xs text-gray-500">${user.country || '-'} | <span class="text-green-600 font-medium">${user.points || 0} Poin</span></p>
                            </div>
                            ${isBlocked ? '<span class="px-1.5 py-0.5 bg-red-100 text-red-700 rounded text-xs">Blocked</span>' : ''}
                        </div>
                        <div class="flex gap-1.5 mt-2">
                            <button type="button" onclick="openEditUserModal('${user.__backendId}')" class="flex-1 py-1.5 bg-blue-100 text-blue-700 rounded text-xs font-medium hover:bg-blue-200">Edit</button>
                            <button type="button" onclick="toggleBlockUser('${user.__backendId}')" class="flex-1 py-1.5 ${isBlocked ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'} rounded text-xs font-medium hover:opacity-80">
                                ${isBlocked ? 'Unblock' : 'Block'}
                            </button>
                            <button type="button" onclick="deleteUser('${user.__backendId}')" class="flex-1 py-1.5 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200">Hapus</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openEditUserModal(userId) {
            const user = allUsers.find(u => u.__backendId === userId);
            if (!user) return;
            
            document.getElementById('edit-user-id').value = userId;
            document.getElementById('edit-user-username').value = user.username;
            document.getElementById('edit-user-password').value = '';
            document.getElementById('edit-user-current-points').textContent = user.points || 0;
            document.getElementById('edit-user-new-points').value = user.points || 0;
            document.getElementById('edit-user-modal').classList.remove('hidden');
        }

        function closeEditUserModal() {
            document.getElementById('edit-user-modal').classList.add('hidden');
        }

        async function saveEditUser(e) {
            e.preventDefault();
            
            const userId = document.getElementById('edit-user-id').value;
            const newPassword = document.getElementById('edit-user-password').value;
            const newPoints = parseInt(document.getElementById('edit-user-new-points').value) || 0;
            
            const user = allUsers.find(u => u.__backendId === userId);
            if (!user) return;
            
            const oldPoints = user.points || 0;
            
            if (newPassword) {
                user.password = newPassword;
            }
            
            user.points = newPoints;
            
            await window.dataSdk.update(user);
            
            // Sync to GAS
            await sendDataToGAS('updateUser', user);
            
            closeEditUserModal();
            showToast('User berhasil diperbarui!', 'success');
            renderUserList();
            
            if (currentUser && currentUser.__backendId === userId) {
                currentUser.points = newPoints;
                updatePointsDisplay();
                
                const pointDiff = newPoints - oldPoints;
                if (pointDiff !== 0) {
                    const message = pointDiff > 0 ? 
                        `âœ¨ Poin Anda ditambah ${pointDiff}! Total: ${newPoints}` : 
                        `âš ï¸ Poin Anda dikurangi ${Math.abs(pointDiff)}. Total: ${newPoints}`;
                    showToast(message, 'success');
                }
            }
        }

        async function toggleBlockUser(userId) {
            const user = allUsers.find(u => u.__backendId === userId);
            if (!user) return;
            
            user.blocked = !user.blocked;
            await window.dataSdk.update(user);
            
            // Sync to GAS
            await sendDataToGAS('updateUser', user);
            
            showToast(user.blocked ? 'User diblokir' : 'User di-unblock', 'success');
            renderUserList();
        }

        async function deleteUser(userId) {
            const user = allUsers.find(u => u.__backendId === userId);
            if (!user) return;
            
            await window.dataSdk.delete(user);
            
            // Sync to GAS
            await sendDataToGAS('deleteUser', user);
            
            showToast('User berhasil dihapus!', 'success');
        }

        function renderAdminExchangeList() {
            const container = document.getElementById('admin-exchange-list');
            const allExchangesData = allExchanges.sort((a, b) => new Date(b.requestedAt) - new Date(a.requestedAt));
            
            if (allExchangesData.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-3 text-xs">Belum ada permintaan penukaran</p>';
                return;
            }
            
            container.innerHTML = allExchangesData.map(ex => {
                const statusClass = ex.status === 'pending' ? 'bg-yellow-100 text-yellow-700' : 
                                   ex.status === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700';
                const statusText = ex.status === 'pending' ? 'Pending' : 
                                  ex.status === 'success' ? 'Berhasil' : 'Ditolak';
                const canEdit = ex.status === 'pending';
                
                return `
                    <div class="p-3 bg-gray-50 rounded-lg ${!canEdit ? 'opacity-70' : ''}">
                        <div class="flex items-center justify-between mb-1.5">
                            <span class="font-semibold text-gray-800 text-sm">${ex.username}</span>
                            <span class="px-2 py-0.5 ${statusClass} rounded text-xs font-medium">${statusText}</span>
                        </div>
                        <div class="flex items-center justify-between mb-1">
                            <span class="text-green-600 font-bold text-sm">${ex.amount} Poin</span>
                            <span class="text-xs text-gray-400">${new Date(ex.requestedAt).toLocaleString('id-ID')}</span>
                        </div>
                        <p class="text-xs text-gray-500">${ex.danaAccount}</p>
                        <p class="text-xs text-gray-500">${ex.danaPhone}</p>
                        ${ex.adminNote ? `<p class="text-xs text-blue-600 mt-1.5 p-1.5 bg-blue-50 rounded">ğŸ“ ${ex.adminNote}</p>` : ''}
                        <div class="flex gap-1.5 mt-2">
                            ${canEdit ? `
                                <button type="button" onclick="openExchangeStatusModal('${ex.__backendId}')" class="flex-1 py-1.5 bg-blue-100 text-blue-700 rounded text-xs font-medium hover:bg-blue-200">Ubah</button>
                                <button type="button" onclick="deleteExchangeAdmin('${ex.__backendId}')" class="flex-1 py-1.5 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200">Hapus</button>
                            ` : `
                                <button type="button" onclick="deleteExchangeAdmin('${ex.__backendId}')" class="flex-1 py-1.5 bg-red-100 text-red-700 rounded text-xs font-medium hover:bg-red-200">Hapus</button>
                            `}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function openExchangeStatusModal(exchangeId) {
            const exchange = allExchanges.find(ex => ex.__backendId === exchangeId);
            if (!exchange) return;
            
            document.getElementById('exchange-status-id').value = exchangeId;
            document.getElementById('exchange-status-user-id').value = exchange.userId;
            document.getElementById('exchange-status-amount').value = exchange.amount;
            document.getElementById('exchange-status-select').value = 'success';
            document.getElementById('exchange-status-note').value = '';
            document.getElementById('exchange-status-modal').classList.remove('hidden');
        }

        function closeExchangeStatusModal() {
            document.getElementById('exchange-status-modal').classList.add('hidden');
        }

        async function saveExchangeStatus(e) {
            e.preventDefault();
            
            const exchangeId = document.getElementById('exchange-status-id').value;
            const userId = document.getElementById('exchange-status-user-id').value;
            const amount = parseInt(document.getElementById('exchange-status-amount').value);
            const status = document.getElementById('exchange-status-select').value;
            const note = document.getElementById('exchange-status-note').value;
            
            const exchange = allExchanges.find(ex => ex.__backendId === exchangeId);
            if (!exchange) return;
            
            if (status === 'rejected') {
                const user = allUsers.find(u => u.__backendId === userId);
                if (user) {
                    user.points = (user.points || 0) + amount;
                    await window.dataSdk.update(user);
                    
                    // Sync to GAS
                    await sendDataToGAS('updateUser', user);
                    
                    if (currentUser && currentUser.__backendId === userId) {
                        currentUser.points = user.points;
                        updatePointsDisplay();
                        showToast(`âœ… Poin ${amount} dikembalikan! Total: ${user.points}`, 'success');
                    } else {
                        showToast(`âœ… Poin ${amount} dikembalikan ke ${user.username}`, 'success');
                    }
                }
            }
            
            exchange.status = status;
            exchange.adminNote = note;
            await window.dataSdk.update(exchange);
            
            // Sync to GAS
            await sendDataToGAS('updateExchange', exchange);
            
            closeExchangeStatusModal();
            if (status !== 'rejected') {
                showToast(`Status diubah ke Berhasil âœ…`, 'success');
            }
            renderAdminExchangeList();
        }

        async function deleteExchangeAdmin(exchangeId) {
            const exchange = allExchanges.find(ex => ex.__backendId === exchangeId);
            if (!exchange) return;
            
            await window.dataSdk.delete(exchange);
            
            // Sync to GAS
            await sendDataToGAS('deleteExchange', exchange);
            
            showToast('Riwayat penukaran dihapus!', 'success');
        }

        // Auth Functions
        async function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            
            const user = allUsers.find(u => u.type === 'user' && u.username === username && u.password === password);
            
            if (!user) {
                showToast('Username atau password salah!', 'error');
                return;
            }
            
            if (user.blocked) {
                showToast('Akun Anda diblokir!', 'error');
                return;
            }
            
            user.lastLogin = new Date().toISOString();
            await window.dataSdk.update(user);
            
            // Sync to GAS
            await sendDataToGAS('updateUser', user);
            
            currentUser = user;
            saveSession(user);
            
            afterLogin();
        }

        async function handleRegister(e) {
            e.preventDefault();
            
            const username = document.getElementById('reg-username').value.trim();
            const password = document.getElementById('reg-password').value;
            const country = document.getElementById('reg-country').value;
            
            const exists = allUsers.find(u => u.username === username);
            if (exists) {
                showToast('Username sudah digunakan!', 'error');
                return;
            }
            
            if (allUsers.filter(u => u.type === 'user').length >= 900) {
                showToast('Pendaftaran ditutup sementara', 'error');
                return;
            }
            
            const isFirstUser = allUsers.filter(u => u.type === 'user').length === 0;
            
            const newUser = {
                type: 'user',
                username: username,
                password: password,
                role: isFirstUser ? 'admin' : 'user',
                country: country,
                deviceId: deviceId,
                points: 0,
                blocked: false,
                createdAt: new Date().toISOString(),
                lastLogin: new Date().toISOString()
            };
            
            await window.dataSdk.create(newUser);
            
            // Sync to GAS
            await sendDataToGAS('createUser', newUser);
            
            showToast(isFirstUser ? 'Selamat! Anda terdaftar sebagai Admin' : 'Pendaftaran berhasil! Silakan login', 'success');
            showPage('login-page');
        }

        function handleLogout() {
            clearSession();
            currentUser = null;
            stopHistoryRefresh();
            showPage('login-page');
            document.getElementById('login-form').reset();
        }

        function afterLogin() {
            if (!currentUser) return;
            
            if (appSettings?.maintenanceMode && currentUser.role !== 'admin') {
                showPage('maintenance-page');
                return;
            }
            
            document.getElementById('header-username').textContent = currentUser.username;
            document.getElementById('profile-username').textContent = currentUser.username;
            document.getElementById('profile-role').textContent = currentUser.role === 'admin' ? 'Admin' : 'User';
            document.getElementById('profile-country').textContent = currentUser.country || '-';
            document.getElementById('profile-device').textContent = currentUser.deviceId || deviceId;
            
            updatePointsDisplay();
            displayBroadcast();
            
            if (currentUser.role === 'admin') {
                document.getElementById('settings-nav-btn').classList.remove('hidden');
                if (appSettings) {
                    document.getElementById('maintenance-toggle').checked = appSettings.maintenanceMode || false;
                    document.getElementById('reward-points-input').value = appSettings.rewardPoints || 50;
                }
            } else {
                document.getElementById('settings-nav-btn').classList.add('hidden');
            }
            
            showPage('main-app');
            showSection('quiz');
            generateQuiz();
        }

        // Data Handler
        const dataHandler = {
            onDataChanged(data) {
                allUsers = data.filter(d => d.type === 'user');
                allExchanges = data.filter(d => d.type === 'exchange');
                allBroadcasts = data.filter(d => d.type === 'broadcast');
                appSettings = data.find(d => d.type === 'settings');
                
                if (currentUser) {
                    const updated = allUsers.find(u => u.__backendId === currentUser.__backendId);
                    if (updated) {
                        const pointsChanged = currentUser.points !== updated.points;
                        currentUser = updated;
                        
                        if (pointsChanged) {
                            updatePointsDisplay();
                        }
                    }
                    
                    displayBroadcast();
                    
                    if (appSettings?.maintenanceMode && currentUser.role !== 'admin' && document.getElementById('main-app').classList.contains('active')) {
                        handleLogout();
                        showPage('maintenance-page');
                        showToast('Aplikasi sedang maintenance', 'info');
                    }
                }
                
                if (currentUser?.role === 'admin') {
                    if (appSettings) {
                        document.getElementById('maintenance-toggle').checked = appSettings.maintenanceMode || false;
                        document.getElementById('reward-points-input').value = appSettings.rewardPoints || 50;
                    }
                }
            }
        };

        // Element SDK Handler
        async function onConfigChange(config) {
            document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
        }

        // Initialize
        async function init() {
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange,
                    mapToCapabilities: () => ({
                        recolorables: [],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ['app_title', config.app_title || defaultConfig.app_title]
                    ])
                });
            }
            
            if (window.dataSdk) {
                await window.dataSdk.init(dataHandler);
            }
            
            // Detect country on page load
            detectCountry();
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('register-form').addEventListener('submit', handleRegister);
            document.getElementById('exchange-form').addEventListener('submit', submitExchange);
            document.getElementById('edit-user-form').addEventListener('submit', saveEditUser);
            document.getElementById('exchange-status-form').addEventListener('submit', saveExchangeStatus);
            document.getElementById('broadcast-form').addEventListener('submit', submitBroadcast);
            
            const session = getSession();
            if (session) {
                setTimeout(() => {
                    const user = allUsers.find(u => u.__backendId === session.userId);
                    if (user && !user.blocked) {
                        currentUser = user;
                        afterLogin();
                    } else {
                        clearSession();
                    }
                }, 1000);
            }
        }

        init();
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9ce60062f63687f6',t:'MTc3MTE3MTA1Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
