<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App - Iklan & Penarikan</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            text-align: center;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: pink transparant;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .info {
            margin-bottom: 20px;
        }
        .button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        .message {
            margin-top: 20px;
            color: #333;
            font-weight: bold;
        }
        .message.error {
            color: #ff0000;
        }
        .countdown {
            margin-top: 10px;
            font-size: 14px;
            color: #555;
        }
        .withdrawal-form, .history-table {
            display: none;
            margin-top: 20px;
            text-align: left;
        }
        .withdrawal-form input, .withdrawal-form select {
            width: 100%;
            padding: 8px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
        .withdrawal-form button {
            margin-right: 10px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Iklan Harian</h1>
        
        <div class="info">
            <p>Iklan Dilihat Hari Ini: <span id="adsViewed">0</span></p>
            <p>Total Iklan Dilihat: <span id="totalAdsViewed">0</span></p>
            <p>Batas Iklan per Hari: <span id="dailyLimit">5</span></p>
            <p>Poin Anda: <span id="points">0</span></p>
        </div>

        <button class="button" id="viewAdButton" onclick="viewAd()">Lihat Iklan</button>
        <button class="button" id="withdrawalButton" onclick="showWithdrawalForm()">Penarikan</button>
        <button class="button" id="historyButton" onclick="showHistory()">Riwayat Penarikan</button>
        <button class="button" id="joinGroupButton" onclick="joinGroup()">Gabung Group Telegram</button>

        <!-- Hitungan mundur -->
        <div id="countdown" class="countdown"></div>

        <!-- Pesan akan ditampilkan di sini -->
        <div id="message" class="message"></div>

        <!-- Formulir Penarikan -->
        <div id="withdrawalForm" class="withdrawal-form">
            <input type="text" id="name" placeholder="Nama Lengkap" required>
            <input type="text" id="phone" placeholder="Nomor HP" required>
            <input type="number" id="amount" placeholder="Jumlah Poin" required>
            <select id="paymentMethod" required>
                <option value="">Pilih Metode Pembayaran</option>
                <option value="DANA">DANA</option>
                <option value="SHOPEE">SHOPEE</option>
            </select>
            <button class="button" onclick="submitWithdrawal()">Kirim</button>
            <button class="button" onclick="hideWithdrawalForm()">Batal</button>
        </div>

        <!-- Tabel Riwayat Penarikan -->
        <div id="historyTable" class="history-table">
            <table>
                <thead>
                    <tr>
                        <th>Nama</th>
                        <th>Nomor HP</th>
                        <th>Jumlah Poin</th>
                        <th>Metode Pembayaran</th>
                        <th>Status</th>
                        <th>Tanggal</th>
                    </tr>
                </thead>
                <tbody id="historyBody">
                    <!-- Data riwayat akan dimuat di sini -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Script Monetag -->
    <script src='//whephiwums.com/sdk.js' data-zone='8654720' data-sdk='show_8654720'></script>

    <script>
        // Data yang disimpan di localStorage
        let adsViewedToday = parseInt(localStorage.getItem('adsViewedToday')) || 0;
        let totalAdsViewed = parseInt(localStorage.getItem('totalAdsViewed')) || 0;
        let points = parseInt(localStorage.getItem('points')) || 100; // Poin awal (contoh: 100 poin)
        const dailyLimit = 5;
        let countdownInterval;
        const countdownDuration = 10; // Hitungan mundur dalam detik

        // Riwayat penarikan disimpan di localStorage
        let withdrawalHistory = JSON.parse(localStorage.getItem('withdrawalHistory')) || [];

        // Token Bot Telegram dan Chat ID Admin
        const botToken = 'YOUR_BOT_TOKEN'; // Ganti dengan token bot Telegram Anda
        const adminChatId = 'ADMIN_CHAT_ID'; // Ganti dengan chat ID admin

        // Link Group Telegram
        const telegramGroupLink = 'https://t.me/namagroup'; // Ganti dengan link group Telegram Anda

        // Fungsi untuk menyimpan data ke localStorage
        function saveToLocalStorage() {
            localStorage.setItem('adsViewedToday', adsViewedToday);
            localStorage.setItem('totalAdsViewed', totalAdsViewed);
            localStorage.setItem('points', points);
            localStorage.setItem('withdrawalHistory', JSON.stringify(withdrawalHistory));
        }

        // Fungsi untuk memperbarui UI
        function updateUI() {
            document.getElementById('adsViewed').textContent = adsViewedToday;
            document.getElementById('totalAdsViewed').textContent = totalAdsViewed;
            document.getElementById('dailyLimit').textContent = dailyLimit;
            document.getElementById('points').textContent = points;

            if (adsViewedToday >= dailyLimit) {
                document.getElementById('viewAdButton').disabled = true;
                showMessage("Anda telah mencapai batas iklan harian.", true);
            }
        }

        // Fungsi untuk menampilkan pesan
        function showMessage(text, isError = false) {
            const messageElement = document.getElementById('message');
            messageElement.textContent = text;
            messageElement.className = isError ? 'message error' : 'message';
        }

        // Fungsi untuk memulai hitungan mundur
        function startCountdown() {
            let timeLeft = countdownDuration;
            document.getElementById('countdown').textContent = `Tombol akan aktif dalam ${timeLeft} detik...`;

            countdownInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('countdown').textContent = `Tombol akan aktif dalam ${timeLeft} detik...`;

                if (timeLeft <= 0) {
                    clearInterval(countdownInterval);
                    document.getElementById('countdown').textContent = '';
                    document.getElementById('viewAdButton').disabled = false;
                    showMessage("Tombol aktif kembali. Silakan lihat iklan lagi.");
                }
            }, 1000);
        }

        // Fungsi untuk melihat iklan
        function viewAd() {
            if (adsViewedToday >= dailyLimit) {
                showMessage("Anda telah mencapai batas iklan harian.", true);
                return;
            }

            // Cek apakah fungsi Monetag tersedia
            if (typeof show_8654720 === 'undefined') {
                showMessage("Iklan tidak dapat dimuat. Silakan coba lagi.", true);
                return;
            }

            // Nonaktifkan tombol sementara
            document.getElementById('viewAdButton').disabled = true;

            // Tampilkan iklan
            show_8654720();

            // Simulasikan callback atau event listener dari Monetag
            setTimeout(() => {
                onAdCompleted();
            }, 5000); // Ganti dengan callback asli dari Monetag jika tersedia
        }

        // Fungsi yang dipanggil ketika iklan selesai dilihat
        function onAdCompleted() {
            adsViewedToday++;
            totalAdsViewed++;
            points += 10; // Tambahkan 10 poin setiap iklan selesai dilihat
            saveToLocalStorage(); // Simpan perubahan ke localStorage
            updateUI();
            showMessage("Iklan selesai dilihat! Poin bertambah.");

            // Mulai hitungan mundur sebelum tombol aktif kembali
            startCountdown();
        }

        // Fungsi yang dipanggil ketika iklan gagal dimuat
        function onAdFailed() {
            showMessage("Iklan tidak muncul. Poin tidak bertambah.", true);
            document.getElementById('viewAdButton').disabled = false; // Aktifkan tombol kembali
        }

        // Fungsi untuk menampilkan formulir penarikan
        function showWithdrawalForm() {
            document.getElementById('withdrawalForm').style.display = 'block';
            document.getElementById('historyTable').style.display = 'none';
        }

        // Fungsi untuk menyembunyikan formulir penarikan
        function hideWithdrawalForm() {
            document.getElementById('withdrawalForm').style.display = 'none';
        }

        // Fungsi untuk mengirim penarikan
        async function submitWithdrawal() {
            const name = document.getElementById('name').value;
            const phone = document.getElementById('phone').value;
            const amount = parseInt(document.getElementById('amount').value);
            const paymentMethod = document.getElementById('paymentMethod').value;

            if (!name || !phone || !amount || !paymentMethod) {
                showMessage("Harap isi semua field.", true);
                return;
            }

            if (amount > points) {
                showMessage("Poin tidak mencukupi.", true);
                return;
            }

            // Tambahkan riwayat penarikan
            const withdrawal = {
                name,
                phone,
                amount,
                paymentMethod,
                status: "Pending",
                date: new Date().toLocaleString()
            };
            withdrawalHistory.push(withdrawal);
            saveToLocalStorage(); // Simpan perubahan ke localStorage

            // Kurangi poin
            points -= amount;
            saveToLocalStorage(); // Simpan perubahan ke localStorage
            updateUI();

            // Kirim data penarikan ke admin via API Telegram
            const message = `📝 *Penarikan Baru*:\n\n` +
                            `Nama: ${name}\n` +
                            `Nomor HP: ${phone}\n` +
                            `Jumlah Poin: ${amount}\n` +
                            `Metode Pembayaran: ${paymentMethod}`;

            const apiUrl = `https://api.telegram.org/bot${botToken}/sendMessage`;
            const payload = {
                chat_id: adminChatId,
                text: message,
                parse_mode: 'Markdown'
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                if (data.ok) {
                    showMessage("Penarikan berhasil dikirim ke admin.");
                    hideWithdrawalForm();
                } else {
                    showMessage("Gagal mengirim penarikan. Silakan coba lagi.", true);
                }
            } catch (error) {
                showMessage("Terjadi kesalahan. Silakan coba lagi.", true);
            }
        }

        // Fungsi untuk menampilkan riwayat penarikan
        function showHistory() {
            document.getElementById('withdrawalForm').style.display = 'none';
            document.getElementById('historyTable').style.display = 'block';

            const historyBody = document.getElementById('historyBody');
            historyBody.innerHTML = ''; // Kosongkan tabel sebelum mengisi data baru

            withdrawalHistory.forEach(withdrawal => {
                const newRow = document.createElement('tr');
                newRow.innerHTML = `
                    <td>${withdrawal.name}</td>
                    <td>${withdrawal.phone}</td>
                    <td>${withdrawal.amount}</td>
                    <td>${withdrawal.paymentMethod}</td>
                    <td>${withdrawal.status}</td>
                    <td>${withdrawal.date}</td>
                `;
                historyBody.appendChild(newRow);
            });
        }

        // Fungsi untuk bergabung dengan group Telegram
        function joinGroup() {
            window.open(telegramGroupLink, '_blank'); // Buka link group Telegram di tab baru
        }

        // Initialize UI
        updateUI();
    </script>
</body>
</html>
